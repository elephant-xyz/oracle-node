Comment: Elephant Express workflow. Triggered by Starter Lambda with one SQS message payload.
StartAt: Preprocess
States:
  Preprocess:
    Type: Task
    Resource: arn:aws:states:::lambda:invoke
    Parameters:
      FunctionName: ${WorkflowPreProcessorFunction}
      Payload.$: $.message
    # Store full Lambda invoke result under $.pre so we can shape it next
    ResultSelector:
      county_prep_input_s3_uri.$: $.Payload.county_prep_input_s3_uri
      output_prefix.$: $.Payload.output_prefix
      seed_output_s3_uri.$: $.Payload.seed_output_s3_uri
    ResultPath: $.pre
    Next: Prepare
    Retry:
      - ErrorEquals:
          [
            Lambda.ServiceException,
            Lambda.AWSLambdaException,
            Lambda.SdkClientException,
          ]
        IntervalSeconds: 2
        MaxAttempts: 2
        BackoffRate: 2
    Catch:
      - ErrorEquals: [States.ALL]
        ResultPath: $.error
        Next: RequeueOnFailure

  Prepare:
    Type: Task
    Resource: arn:aws:states:::lambda:invoke
    Parameters:
      FunctionName: ${DownloaderFunction}
      Payload:
        input_s3_uri.$: $.pre.county_prep_input_s3_uri
        output_s3_uri_prefix.$: $.pre.output_prefix
        browser: true
    ResultSelector:
      output_s3_uri.$: $.Payload.output_s3_uri
    ResultPath: $.prepare
    Next: Postprocess
    Retry:
      - ErrorEquals:
          [
            Lambda.ServiceException,
            Lambda.AWSLambdaException,
            Lambda.SdkClientException,
          ]
        IntervalSeconds: 5
        MaxAttempts: 3
        BackoffRate: 2
    Catch:
      - ErrorEquals: [States.ALL]
        ResultPath: $.error
        Next: RequeueOnFailure

  Postprocess:
    Type: Task
    Resource: arn:aws:states:::lambda:invoke
    Parameters:
      FunctionName: ${WorkflowPostProcessorFunction}
      Payload:
        s3.$: $.message.s3
        prepare.$: $.prepare
        seed_output_s3_uri.$: $.pre.seed_output_s3_uri
    # Discard Lambda result; we only need to requeue original Records
    ResultPath: null
    OutputPath: "$"
    Next: RequeueOnSuccess
    Retry:
      - ErrorEquals:
          [
            Lambda.ServiceException,
            Lambda.AWSLambdaException,
            Lambda.SdkClientException,
          ]
        IntervalSeconds: 5
        MaxAttempts: 2
        BackoffRate: 2
    Catch:
      - ErrorEquals: [States.ALL]
        ResultPath: $.error
        Next: RequeueOnFailure

  RequeueOnSuccess:
    Type: Task
    Resource: arn:aws:states:::sqs:sendMessage
    Parameters:
      QueueUrl: ${WorkflowSqsQueueUrl}
      MessageBody.$: "States.JsonToString($.message)"
    ResultPath: null
    End: true

  RequeueOnFailure:
    Type: Task
    Resource: arn:aws:states:::sqs:sendMessage
    Parameters:
      QueueUrl: ${WorkflowSqsQueueUrl}
      MessageBody.$: "States.JsonToString($.message)"
    ResultPath: null
    Next: FailRuntime

  FailRuntime:
    Type: Fail
    Error: WorkflowFailed
    Cause: A task failed. See error field.
