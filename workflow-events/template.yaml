AWSTemplateFormatVersion: "2010-09-09"
Transform: AWS::Serverless-2016-10-31
Description: SAM template for processing EventBridge WorkflowEvent events with TypeScript Lambda

Parameters:
  EnvironmentName:
    Description: An environment name that is prefixed to resource names
    Type: String
    Default: MWAAEnvironment

Globals:
  Function:
    Timeout: 60
    MemorySize: 128
    LoggingConfig:
      LogFormat: JSON

Resources:
  # Shared layer containing common code for all lambdas
  SharedLayer:
    Type: AWS::Serverless::LayerVersion
    Properties:
      LayerName: !Sub "${EnvironmentName}-workflow-events-shared"
      Description: Shared utilities for workflow-events lambdas (DynamoDB client, types, keys)
      ContentUri: layers/shared
      CompatibleRuntimes:
        - nodejs22.x
      CompatibleArchitectures:
        - arm64
      RetentionPolicy: Delete
    Metadata:
      BuildMethod: makefile
      BuildArchitecture: arm64

  # DynamoDB table for storing workflow errors with single-table design
  WorkflowErrorsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub "${EnvironmentName}-workflow-errors"
      BillingMode: PAY_PER_REQUEST
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: true
      AttributeDefinitions:
        - AttributeName: PK
          AttributeType: S
        - AttributeName: SK
          AttributeType: S
        - AttributeName: GS1PK
          AttributeType: S
        - AttributeName: GS1SK
          AttributeType: S
        - AttributeName: GS2PK
          AttributeType: S
        - AttributeName: GS2SK
          AttributeType: S
        - AttributeName: GS3PK
          AttributeType: S
        - AttributeName: GS3SK
          AttributeType: S
      KeySchema:
        - AttributeName: PK
          KeyType: HASH
        - AttributeName: SK
          KeyType: RANGE
      GlobalSecondaryIndexes:
        # GSI1: Error-to-execution lookups (ErrorRecord, ExecutionErrorLink)
        - IndexName: GS1
          KeySchema:
            - AttributeName: GS1PK
              KeyType: HASH
            - AttributeName: GS1SK
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
        # GSI2: Count-based sorting for errors (ErrorRecord)
        - IndexName: GS2
          KeySchema:
            - AttributeName: GS2PK
              KeyType: HASH
            - AttributeName: GS2SK
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
        # GSI3: Error count sorting (ErrorRecord and FailedExecutionItem)
        - IndexName: GS3
          KeySchema:
            - AttributeName: GS3PK
              KeyType: HASH
            - AttributeName: GS3SK
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
      # Enable DynamoDB Streams for error resolution processing
      StreamSpecification:
        StreamViewType: OLD_IMAGE
      Tags:
        - Key: Environment
          Value: !Ref EnvironmentName

  WorkflowEventHandlerDeadLetterQueue:
    Type: AWS::SQS::Queue
    Properties:
      MessageRetentionPeriod: 1209600
      Tags:
        - Key: Environment
          Value: !Ref EnvironmentName

  WorkflowEventHandlerFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "${EnvironmentName}-workflow-event-handler"
      Runtime: nodejs22.x
      Architectures:
        - arm64
      Handler: index.handler
      CodeUri: lambdas/event-handler
      Layers:
        - !Ref SharedLayer
      DeadLetterQueue:
        TargetArn: !GetAtt WorkflowEventHandlerDeadLetterQueue.Arn
        Type: SQS
      Description: "Processes EventBridge events from elephant.workflow source (WorkflowEvent and ElephantErrorResolved)"
      Environment:
        Variables:
          WORKFLOW_ERRORS_TABLE_NAME: !Ref WorkflowErrorsTable
      Policies:
        - AWSLambdaBasicExecutionRole
        - CloudWatchPutMetricPolicy: {}
        - DynamoDBCrudPolicy:
            TableName: !Ref WorkflowErrorsTable
      Events:
        WorkflowEventRule:
          Type: EventBridgeRule
          Properties:
            Pattern:
              source:
                - elephant.workflow
              detail-type:
                - WorkflowEvent
                - ElephantErrorResolved
                - ElephantErrorFailedToResolve
            State: ENABLED
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Format: esm
        OutExtension:
          - .js=.mjs
        External:
          - "@aws-sdk/*"
          - "@smithy/*"
          - "shared"
        Minify: true
        Target: es2022
        EntryPoints:
          - index.ts
        Sourcemap: true
        LogLevel: info

  GetExecutionFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "${EnvironmentName}-get-execution"
      Runtime: nodejs22.x
      Architectures:
        - arm64
      Handler: index.handler
      CodeUri: lambdas/get-execution
      Layers:
        - !Ref SharedLayer
      Description: "Retrieves executions by error count with optional error type filter"
      Environment:
        Variables:
          WORKFLOW_ERRORS_TABLE_NAME: !Ref WorkflowErrorsTable
      Policies:
        - AWSLambdaBasicExecutionRole
        - DynamoDBReadPolicy:
            TableName: !Ref WorkflowErrorsTable
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Format: esm
        OutExtension:
          - .js=.mjs
        External:
          - "@aws-sdk/*"
          - "@smithy/*"
          - "shared"
        Minify: true
        Target: es2022
        EntryPoints:
          - index.ts
        Sourcemap: true
        LogLevel: info

  # CloudWatch Dashboard Widget Lambda Functions
  DashboardExecutionsWidgetFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "${EnvironmentName}-dashboard-executions-widget"
      Runtime: nodejs22.x
      Architectures:
        - arm64
      Handler: index.handler
      CodeUri: lambdas/dashboard-executions-widget
      Layers:
        - !Ref SharedLayer
      Description: "CloudWatch custom widget displaying executions with most errors"
      Environment:
        Variables:
          WORKFLOW_ERRORS_TABLE_NAME: !Ref WorkflowErrorsTable
      Policies:
        - AWSLambdaBasicExecutionRole
        - DynamoDBReadPolicy:
            TableName: !Ref WorkflowErrorsTable
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Format: esm
        OutExtension:
          - .js=.mjs
        External:
          - "@aws-sdk/*"
          - "@smithy/*"
          - "shared"
        Minify: true
        Target: es2022
        EntryPoints:
          - index.ts
        Sourcemap: true
        LogLevel: info

  DashboardErrorsWidgetFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "${EnvironmentName}-dashboard-errors-widget"
      Runtime: nodejs22.x
      Architectures:
        - arm64
      Handler: index.handler
      CodeUri: lambdas/dashboard-errors-widget
      Layers:
        - !Ref SharedLayer
      Description: "CloudWatch custom widget displaying errors with most occurrences"
      Environment:
        Variables:
          WORKFLOW_ERRORS_TABLE_NAME: !Ref WorkflowErrorsTable
          AWS_ACCOUNT_ID: !Ref AWS::AccountId
      Policies:
        - AWSLambdaBasicExecutionRole
        - DynamoDBReadPolicy:
            TableName: !Ref WorkflowErrorsTable
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Format: esm
        OutExtension:
          - .js=.mjs
        External:
          - "@aws-sdk/*"
          - "@smithy/*"
          - "shared"
        Minify: true
        Target: es2022
        EntryPoints:
          - index.ts
        Sourcemap: true
        LogLevel: info

  # CloudWatch Dashboard with custom widgets for workflow errors
  WorkflowErrorsDashboard:
    Type: AWS::CloudWatch::Dashboard
    Properties:
      DashboardName: elephant-oracle-node-dashboard
      DashboardBody: !Sub |
        {
          "widgets": [
            {
              "type": "custom",
              "x": 0,
              "y": 0,
              "width": 12,
              "height": 10,
              "properties": {
                "title": "Failed Executions",
                "endpoint": "${DashboardExecutionsWidgetFunction.Arn}",
                "updateOn": {
                  "refresh": true,
                  "resize": true
                },
                "params": {
                  "limit": 20,
                  "status": "FAILED"
                }
              }
            },
            {
              "type": "custom",
              "x": 12,
              "y": 0,
              "width": 12,
              "height": 10,
              "properties": {
                "title": "Failed to Solve Executions",
                "endpoint": "${DashboardExecutionsWidgetFunction.Arn}",
                "updateOn": {
                  "refresh": true,
                  "resize": true
                },
                "params": {
                  "limit": 20,
                  "status": "MAYBEUNRECOVERABLE"
                }
              }
            },
            {
              "type": "custom",
              "x": 0,
              "y": 10,
              "width": 12,
              "height": 10,
              "properties": {
                "title": "Failed Errors",
                "endpoint": "${DashboardErrorsWidgetFunction.Arn}",
                "updateOn": {
                  "refresh": true,
                  "resize": true
                },
                "params": {
                  "errorType": "",
                  "limit": 20,
                  "status": "FAILED"
                }
              }
            },
            {
              "type": "custom",
              "x": 12,
              "y": 10,
              "width": 12,
              "height": 10,
              "properties": {
                "title": "Failed to Solve Errors",
                "endpoint": "${DashboardErrorsWidgetFunction.Arn}",
                "updateOn": {
                  "refresh": true,
                  "resize": true
                },
                "params": {
                  "errorType": "",
                  "limit": 20,
                  "status": "MAYBEUNRECOVERABLE"
                }
              }
            },
            {
              "type": "metric",
              "x": 0,
              "y": 20,
              "width": 12,
              "height": 6,
              "properties": {
                "title": "Prepare Phase",
                "view": "timeSeries",
                "stacked": false,
                "region": "${AWS::Region}",
                "period": 300,
                "metrics": [
                  [{"expression": "SUM(SEARCH('{Elephant/Workflow,County,Status,Step,DataGroupName} MetricName=\"PrepareElephantPhase\" Status=\"SCHEDULED\"', 'Sum', 300))", "label": "SCHEDULED", "id": "prep_sched", "color": "#1f77b4"}],
                  [{"expression": "SUM(SEARCH('{Elephant/Workflow,County,Status,Step,DataGroupName} MetricName=\"PrepareElephantPhase\" Status=\"IN_PROGRESS\"', 'Sum', 300))", "label": "IN_PROGRESS", "id": "prep_prog", "color": "#ff7f0e"}],
                  [{"expression": "SUM(SEARCH('{Elephant/Workflow,County,Status,Step,DataGroupName} MetricName=\"PrepareElephantPhase\" Status=\"SUCCEEDED\"', 'Sum', 300))", "label": "SUCCEEDED", "id": "prep_succ", "color": "#2ca02c"}],
                  [{"expression": "SUM(SEARCH('{Elephant/Workflow,County,Status,Step,DataGroupName} MetricName=\"PrepareElephantPhase\" Status=\"FAILED\"', 'Sum', 300))", "label": "FAILED", "id": "prep_fail", "color": "#d62728"}]
                ]
              }
            },
            {
              "type": "metric",
              "x": 12,
              "y": 20,
              "width": 12,
              "height": 6,
              "properties": {
                "title": "Transform Phase",
                "view": "timeSeries",
                "stacked": false,
                "region": "${AWS::Region}",
                "period": 300,
                "metrics": [
                  [{"expression": "SUM(SEARCH('{Elephant/Workflow,County,Status,Step,DataGroupName} MetricName=\"TransformElephantPhase\" Status=\"SCHEDULED\"', 'Sum', 300))", "label": "SCHEDULED", "id": "trans_sched", "color": "#1f77b4"}],
                  [{"expression": "SUM(SEARCH('{Elephant/Workflow,County,Status,Step,DataGroupName} MetricName=\"TransformElephantPhase\" Status=\"IN_PROGRESS\"', 'Sum', 300))", "label": "IN_PROGRESS", "id": "trans_prog", "color": "#ff7f0e"}],
                  [{"expression": "SUM(SEARCH('{Elephant/Workflow,County,Status,Step,DataGroupName} MetricName=\"TransformElephantPhase\" Status=\"SUCCEEDED\"', 'Sum', 300))", "label": "SUCCEEDED", "id": "trans_succ", "color": "#2ca02c"}],
                  [{"expression": "SUM(SEARCH('{Elephant/Workflow,County,Status,Step,DataGroupName} MetricName=\"TransformElephantPhase\" Status=\"FAILED\"', 'Sum', 300))", "label": "FAILED", "id": "trans_fail", "color": "#d62728"}]
                ]
              }
            },
            {
              "type": "metric",
              "x": 0,
              "y": 26,
              "width": 12,
              "height": 6,
              "properties": {
                "title": "SVL Phase",
                "view": "timeSeries",
                "stacked": false,
                "region": "${AWS::Region}",
                "period": 300,
                "metrics": [
                  [{"expression": "SUM(SEARCH('{Elephant/Workflow,County,Status,Step,DataGroupName} MetricName=\"SVLElephantPhase\" Status=\"SCHEDULED\"', 'Sum', 300))", "label": "SCHEDULED", "id": "svl_sched", "color": "#1f77b4"}],
                  [{"expression": "SUM(SEARCH('{Elephant/Workflow,County,Status,Step,DataGroupName} MetricName=\"SVLElephantPhase\" Status=\"IN_PROGRESS\"', 'Sum', 300))", "label": "IN_PROGRESS", "id": "svl_prog", "color": "#ff7f0e"}],
                  [{"expression": "SUM(SEARCH('{Elephant/Workflow,County,Status,Step,DataGroupName} MetricName=\"SVLElephantPhase\" Status=\"SUCCEEDED\"', 'Sum', 300))", "label": "SUCCEEDED", "id": "svl_succ", "color": "#2ca02c"}],
                  [{"expression": "SUM(SEARCH('{Elephant/Workflow,County,Status,Step,DataGroupName} MetricName=\"SVLElephantPhase\" Status=\"FAILED\"', 'Sum', 300))", "label": "FAILED", "id": "svl_fail", "color": "#d62728"}]
                ]
              }
            },
            {
              "type": "metric",
              "x": 12,
              "y": 26,
              "width": 12,
              "height": 6,
              "properties": {
                "title": "MVL Phase",
                "view": "timeSeries",
                "stacked": false,
                "region": "${AWS::Region}",
                "period": 300,
                "metrics": [
                  [{"expression": "SUM(SEARCH('{Elephant/Workflow,County,Status,Step,DataGroupName} MetricName=\"MVLElephantPhase\" Status=\"SCHEDULED\"', 'Sum', 300))", "label": "SCHEDULED", "id": "mvl_sched", "color": "#1f77b4"}],
                  [{"expression": "SUM(SEARCH('{Elephant/Workflow,County,Status,Step,DataGroupName} MetricName=\"MVLElephantPhase\" Status=\"IN_PROGRESS\"', 'Sum', 300))", "label": "IN_PROGRESS", "id": "mvl_prog", "color": "#ff7f0e"}],
                  [{"expression": "SUM(SEARCH('{Elephant/Workflow,County,Status,Step,DataGroupName} MetricName=\"MVLElephantPhase\" Status=\"SUCCEEDED\"', 'Sum', 300))", "label": "SUCCEEDED", "id": "mvl_succ", "color": "#2ca02c"}],
                  [{"expression": "SUM(SEARCH('{Elephant/Workflow,County,Status,Step,DataGroupName} MetricName=\"MVLElephantPhase\" Status=\"FAILED\"', 'Sum', 300))", "label": "FAILED", "id": "mvl_fail", "color": "#d62728"}]
                ]
              }
            },
            {
              "type": "metric",
              "x": 0,
              "y": 32,
              "width": 12,
              "height": 6,
              "properties": {
                "title": "Hash Phase",
                "view": "timeSeries",
                "stacked": false,
                "region": "${AWS::Region}",
                "period": 300,
                "metrics": [
                  [{"expression": "SUM(SEARCH('{Elephant/Workflow,County,Status,Step,DataGroupName} MetricName=\"HashElephantPhase\" Status=\"SCHEDULED\"', 'Sum', 300))", "label": "SCHEDULED", "id": "hash_sched", "color": "#1f77b4"}],
                  [{"expression": "SUM(SEARCH('{Elephant/Workflow,County,Status,Step,DataGroupName} MetricName=\"HashElephantPhase\" Status=\"IN_PROGRESS\"', 'Sum', 300))", "label": "IN_PROGRESS", "id": "hash_prog", "color": "#ff7f0e"}],
                  [{"expression": "SUM(SEARCH('{Elephant/Workflow,County,Status,Step,DataGroupName} MetricName=\"HashElephantPhase\" Status=\"SUCCEEDED\"', 'Sum', 300))", "label": "SUCCEEDED", "id": "hash_succ", "color": "#2ca02c"}],
                  [{"expression": "SUM(SEARCH('{Elephant/Workflow,County,Status,Step,DataGroupName} MetricName=\"HashElephantPhase\" Status=\"FAILED\"', 'Sum', 300))", "label": "FAILED", "id": "hash_fail", "color": "#d62728"}]
                ]
              }
            },
            {
              "type": "metric",
              "x": 12,
              "y": 32,
              "width": 12,
              "height": 6,
              "properties": {
                "title": "Upload Phase",
                "view": "timeSeries",
                "stacked": false,
                "region": "${AWS::Region}",
                "period": 300,
                "metrics": [
                  [{"expression": "SUM(SEARCH('{Elephant/Workflow,County,Status,Step,DataGroupName} MetricName=\"UploadElephantPhase\" Status=\"SCHEDULED\"', 'Sum', 300))", "label": "SCHEDULED", "id": "upload_sched", "color": "#1f77b4"}],
                  [{"expression": "SUM(SEARCH('{Elephant/Workflow,County,Status,Step,DataGroupName} MetricName=\"UploadElephantPhase\" Status=\"IN_PROGRESS\"', 'Sum', 300))", "label": "IN_PROGRESS", "id": "upload_prog", "color": "#ff7f0e"}],
                  [{"expression": "SUM(SEARCH('{Elephant/Workflow,County,Status,Step,DataGroupName} MetricName=\"UploadElephantPhase\" Status=\"SUCCEEDED\"', 'Sum', 300))", "label": "SUCCEEDED", "id": "upload_succ", "color": "#2ca02c"}],
                  [{"expression": "SUM(SEARCH('{Elephant/Workflow,County,Status,Step,DataGroupName} MetricName=\"UploadElephantPhase\" Status=\"FAILED\"', 'Sum', 300))", "label": "FAILED", "id": "upload_fail", "color": "#d62728"}]
                ]
              }
            },
            {
              "type": "metric",
              "x": 0,
              "y": 38,
              "width": 12,
              "height": 6,
              "properties": {
                "title": "Gas Price Check Phase",
                "view": "timeSeries",
                "stacked": false,
                "region": "${AWS::Region}",
                "period": 300,
                "metrics": [
                  [{"expression": "SUM(SEARCH('{Elephant/Workflow,County,Status,Step,DataGroupName} MetricName=\"GasPriceCheckElephantPhase\" Status=\"SCHEDULED\"', 'Sum', 300))", "label": "SCHEDULED", "id": "gasprice_sched", "color": "#1f77b4"}],
                  [{"expression": "SUM(SEARCH('{Elephant/Workflow,County,Status,Step,DataGroupName} MetricName=\"GasPriceCheckElephantPhase\" Status=\"IN_PROGRESS\"', 'Sum', 300))", "label": "IN_PROGRESS", "id": "gasprice_prog", "color": "#ff7f0e"}],
                  [{"expression": "SUM(SEARCH('{Elephant/Workflow,County,Status,Step,DataGroupName} MetricName=\"GasPriceCheckElephantPhase\" Status=\"SUCCEEDED\"', 'Sum', 300))", "label": "SUCCEEDED", "id": "gasprice_succ", "color": "#2ca02c"}],
                  [{"expression": "SUM(SEARCH('{Elephant/Workflow,County,Status,Step,DataGroupName} MetricName=\"GasPriceCheckElephantPhase\" Status=\"FAILED\"', 'Sum', 300))", "label": "FAILED", "id": "gasprice_fail", "color": "#d62728"}]
                ]
              }
            },
            {
              "type": "metric",
              "x": 12,
              "y": 38,
              "width": 12,
              "height": 6,
              "properties": {
                "title": "Transaction Status Check Phase",
                "view": "timeSeries",
                "stacked": false,
                "region": "${AWS::Region}",
                "period": 300,
                "metrics": [
                  [{"expression": "SUM(SEARCH('{Elephant/Workflow,County,Status,Step,DataGroupName} MetricName=\"TransactionStatusCheckElephantPhase\" Status=\"SCHEDULED\"', 'Sum', 300))", "label": "SCHEDULED", "id": "txstatus_sched", "color": "#1f77b4"}],
                  [{"expression": "SUM(SEARCH('{Elephant/Workflow,County,Status,Step,DataGroupName} MetricName=\"TransactionStatusCheckElephantPhase\" Status=\"IN_PROGRESS\"', 'Sum', 300))", "label": "IN_PROGRESS", "id": "txstatus_prog", "color": "#ff7f0e"}],
                  [{"expression": "SUM(SEARCH('{Elephant/Workflow,County,Status,Step,DataGroupName} MetricName=\"TransactionStatusCheckElephantPhase\" Status=\"SUCCEEDED\"', 'Sum', 300))", "label": "SUCCEEDED", "id": "txstatus_succ", "color": "#2ca02c"}],
                  [{"expression": "SUM(SEARCH('{Elephant/Workflow,County,Status,Step,DataGroupName} MetricName=\"TransactionStatusCheckElephantPhase\" Status=\"FAILED\"', 'Sum', 300))", "label": "FAILED", "id": "txstatus_fail", "color": "#d62728"}]
                ]
              }
            },
            {
              "type": "metric",
              "x": 0,
              "y": 34,
              "width": 12,
              "height": 6,
              "properties": {
                "title": "Submit Phase",
                "view": "timeSeries",
                "stacked": false,
                "region": "${AWS::Region}",
                "period": 300,
                "metrics": [
                  [{"expression": "SUM(SEARCH('{Elephant/Workflow,County,Status,Step,DataGroupName} MetricName=\"SubmitElephantPhase\" Status=\"SCHEDULED\"', 'Sum', 300))", "label": "SCHEDULED", "id": "submit_sched", "color": "#1f77b4"}],
                  [{"expression": "SUM(SEARCH('{Elephant/Workflow,County,Status,Step,DataGroupName} MetricName=\"SubmitElephantPhase\" Status=\"IN_PROGRESS\"', 'Sum', 300))", "label": "IN_PROGRESS", "id": "submit_prog", "color": "#ff7f0e"}],
                  [{"expression": "SUM(SEARCH('{Elephant/Workflow,County,Status,Step,DataGroupName} MetricName=\"SubmitElephantPhase\" Status=\"SUCCEEDED\"', 'Sum', 300))", "label": "SUCCEEDED", "id": "submit_succ", "color": "#2ca02c"}],
                  [{"expression": "SUM(SEARCH('{Elephant/Workflow,County,Status,Step,DataGroupName} MetricName=\"SubmitElephantPhase\" Status=\"FAILED\"', 'Sum', 300))", "label": "FAILED", "id": "submit_fail", "color": "#d62728"}]
                ]
              }
            },
            {
              "type": "metric",
              "x": 0,
              "y": 50,
              "width": 12,
              "height": 6,
              "properties": {
                "title": "Execution Restarted (Total)",
                "view": "timeSeries",
                "stacked": false,
                "region": "${AWS::Region}",
                "period": 300,
                "metrics": [
                  [{"expression": "SUM(SEARCH('{Elephant/Workflow,ErrorType,County} MetricName=\"ExecutionRestarted\"', 'Sum', 300))", "label": "Total Restarted", "id": "restart_total", "color": "#2ca02c"}]
                ]
              }
            },
            {
              "type": "metric",
              "x": 12,
              "y": 50,
              "width": 12,
              "height": 6,
              "properties": {
                "title": "Execution Restarted by County",
                "view": "timeSeries",
                "stacked": false,
                "region": "${AWS::Region}",
                "period": 300,
                "metrics": [
                  [{"expression": "SEARCH('{Elephant/Workflow,ErrorType,County} MetricName=\"ExecutionRestarted\"', 'Sum', 300)", "label": "", "id": "restart_by_county"}]
                ]
              }
            },
            {
              "type": "metric",
              "x": 12,
              "y": 34,
              "width": 12,
              "height": 6,
              "properties": {
                "title": "AutoRepair Phase",
                "view": "timeSeries",
                "stacked": false,
                "region": "${AWS::Region}",
                "period": 300,
                "metrics": [
                  [{"expression": "SUM(SEARCH('{Elephant/Workflow,County,Status,Step,DataGroupName} MetricName=\"AutoRepairElephantPhase\" Status=\"SCHEDULED\"', 'Sum', 300))", "label": "SCHEDULED", "id": "autorepair_sched", "color": "#1f77b4"}],
                  [{"expression": "SUM(SEARCH('{Elephant/Workflow,County,Status,Step,DataGroupName} MetricName=\"AutoRepairElephantPhase\" Status=\"IN_PROGRESS\"', 'Sum', 300))", "label": "IN_PROGRESS", "id": "autorepair_prog", "color": "#ff7f0e"}],
                  [{"expression": "SUM(SEARCH('{Elephant/Workflow,County,Status,Step,DataGroupName} MetricName=\"AutoRepairElephantPhase\" Status=\"SUCCEEDED\"', 'Sum', 300))", "label": "SUCCEEDED", "id": "autorepair_succ", "color": "#2ca02c"}],
                  [{"expression": "SUM(SEARCH('{Elephant/Workflow,County,Status,Step,DataGroupName} MetricName=\"AutoRepairElephantPhase\" Status=\"FAILED\"', 'Sum', 300))", "label": "FAILED", "id": "autorepair_fail", "color": "#d62728"}]
                ]
              }
            }
          ]
        }

  # Dead letter queue for error count handler
  ErrorCountHandlerDeadLetterQueue:
    Type: AWS::SQS::Queue
    Properties:
      MessageRetentionPeriod: 1209600
      Tags:
        - Key: Environment
          Value: !Ref EnvironmentName

  # Lambda function triggered by DynamoDB Streams to manage error counts
  ErrorCountHandlerFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "${EnvironmentName}-error-count-handler"
      Runtime: nodejs22.x
      Architectures:
        - arm64
      Handler: index.handler
      CodeUri: lambdas/error-count-handler
      Layers:
        - !Ref SharedLayer
      DeadLetterQueue:
        TargetArn: !GetAtt ErrorCountHandlerDeadLetterQueue.Arn
        Type: SQS
      ReservedConcurrentExecutions: 1
      Description: "Processes DynamoDB Stream events to manage error counts and send task success callbacks"
      Environment:
        Variables:
          WORKFLOW_ERRORS_TABLE_NAME: !Ref WorkflowErrorsTable
      Policies:
        - AWSLambdaBasicExecutionRole
        - CloudWatchPutMetricPolicy: {}
        - DynamoDBCrudPolicy:
            TableName: !Ref WorkflowErrorsTable
        - Version: "2012-10-17"
          Statement:
            - Effect: Allow
              Action:
                - states:SendTaskSuccess
              Resource: "*"
      Events:
        DynamoDBStream:
          Type: DynamoDB
          Properties:
            Stream: !GetAtt WorkflowErrorsTable.StreamArn
            StartingPosition: TRIM_HORIZON
            BatchSize: 100
            MaximumBatchingWindowInSeconds: 5
            FilterCriteria:
              Filters:
                - Pattern: '{"eventName": ["REMOVE"]}'
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Format: esm
        OutExtension:
          - .js=.mjs
        External:
          - "@aws-sdk/*"
          - "@smithy/*"
          - "shared"
        Minify: true
        Target: es2022
        EntryPoints:
          - index.ts
        Sourcemap: true
        LogLevel: info

Outputs:
  WorkflowEventHandlerFunctionName:
    Description: Name of the workflow event handler Lambda function
    Value: !Ref WorkflowEventHandlerFunction
  WorkflowEventHandlerFunctionArn:
    Description: ARN of the workflow event handler Lambda function
    Value: !GetAtt WorkflowEventHandlerFunction.Arn
  WorkflowEventRuleName:
    Description: Name of the EventBridge rule that triggers the Lambda
    Value: !Sub "${EnvironmentName}-workflow-event-rule"
  WorkflowErrorsTableName:
    Description: Name of the DynamoDB table for workflow errors
    Value: !Ref WorkflowErrorsTable
  WorkflowErrorsTableArn:
    Description: ARN of the DynamoDB table for workflow errors
    Value: !GetAtt WorkflowErrorsTable.Arn
  GetExecutionFunctionName:
    Description: Name of the get execution Lambda function
    Value: !Ref GetExecutionFunction
  GetExecutionFunctionArn:
    Description: ARN of the get execution Lambda function
    Value: !GetAtt GetExecutionFunction.Arn
  DashboardExecutionsWidgetFunctionName:
    Description: Name of the dashboard executions widget Lambda function
    Value: !Ref DashboardExecutionsWidgetFunction
  DashboardExecutionsWidgetFunctionArn:
    Description: ARN of the dashboard executions widget Lambda function
    Value: !GetAtt DashboardExecutionsWidgetFunction.Arn
  DashboardErrorsWidgetFunctionName:
    Description: Name of the dashboard errors widget Lambda function
    Value: !Ref DashboardErrorsWidgetFunction
  DashboardErrorsWidgetFunctionArn:
    Description: ARN of the dashboard errors widget Lambda function
    Value: !GetAtt DashboardErrorsWidgetFunction.Arn
  WorkflowErrorsDashboardName:
    Description: Name of the CloudWatch dashboard for workflow errors
    Value: !Ref WorkflowErrorsDashboard
  ErrorCountHandlerFunctionName:
    Description: Name of the error count handler Lambda function
    Value: !Ref ErrorCountHandlerFunction
  ErrorCountHandlerFunctionArn:
    Description: ARN of the error count handler Lambda function
    Value: !GetAtt ErrorCountHandlerFunction.Arn
  WorkflowErrorsTableStreamArn:
    Description: ARN of the DynamoDB Stream for workflow errors table
    Value: !GetAtt WorkflowErrorsTable.StreamArn
