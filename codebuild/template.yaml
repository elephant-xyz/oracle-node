AWSTemplateFormatVersion: "2010-09-09"
Transform: AWS::Serverless-2016-10-31
Description: CodeBuild project that prepares runtime bundles and executes the Node.js entry point (with enhanced error handling).

Parameters:
  EnvironmentName:
    Description: An environment name that is prefixed to resource names
    Type: String
    Default: MWAAEnvironment

  RuntimeArtifactsBucket:
    Description: Name of the S3 bucket containing runtime ZIP archives consumed by the prepare CodeBuild job
    Type: String

  RuntimeArtifactsPrefix:
    Description: Optional prefix within the runtime artifacts bucket that filters the ZIP archives (omit leading slash)
    Type: String
    Default: ""

  RuntimeEntryPoint:
    Description: Relative path to the Node.js entry point that the CodeBuild job executes after extraction
    Type: String
    Default: index.js

  ErrorsTableName:
    Description: Name of the DynamoDB table storing execution errors
    Type: String

  TransformS3Prefix:
    Description: S3 URI prefix containing county transform archives
    Type: String
  TransformWorkerFunctionName:
    Description: Name or ARN of the Transform Worker Lambda function
    Type: String
  SvlWorkerFunctionName:
    Description: Name or ARN of the SVL Worker Lambda function
    Type: String
  OutputS3Prefix:
    Description: S3 prefix for workflow output files
    Type: String
  MvlFunctionName:
    Description: Name or ARN of the Mirror Validation Lambda function
    Type: String
  TransactionsSqsQueueUrl:
    Description: URL of the Transactions SQS Queue
    Type: String
  WorkflowSqsQueueUrl:
    Description: URL of the Workflow SQS Queue (triggers workflow)
    Type: String
  DefaultDlqUrl:
    Description: Default Dead Letter Queue URL
    Type: String
  GetExecutionLambdaFunctionName:
    Description: Name or ARN of the get-execution Lambda function from workflow-events
    Type: String
  StateMachineArn:
    Description: ARN of the Step Functions state machine (used to construct execution ARNs)
    Type: String
  AutoRepairSchedule:
    Description: "Schedule expression for auto-repair CodeBuild execution. For rate expressions, use format like '30 minutes' or '5 minutes' (without 'rate()'). For cron, use full expression like 'cron(0 */2 * * ? *)'. Note: Use singular for 1 (e.g., '1 minute') and plural for >1 (e.g., '5 minutes')."
    Type: String
    Default: "30 minutes"
  OutputBaseUri:
    Description: Base S3 URI for outputs
    Type: String
  EnableAutoRepair:
    Description: "Enable or disable auto-repair trigger from validation-only. Set to 'true' to enable, 'false' to disable."
    Type: String
    Default: "false"
    AllowedValues:
      - "true"
      - "false"
  MaxExecutionsPerRun:
    Description: "Maximum number of executions to process per CodeBuild run (empty = process all). Recommended: 25000 for 8-hour limit with 67k+ executions."
    Type: String
    Default: ""
  Concurrency:
    Description: "Number of executions to process in parallel (default: 20). Increase for faster processing, but watch for DynamoDB throttling."
    Type: Number
    Default: 20
    MinValue: 1
    MaxValue: 100
  TransactionsDeadLetterQueueUrl:
    Description: URL of the Transactions Dead Letter Queue
    Type: String

Conditions:
  HasRuntimeArtifactsPrefix: !Not [!Equals [!Ref RuntimeArtifactsPrefix, ""]]

Resources:
  PrepareRuntimeBuildRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: codebuild.amazonaws.com
            Action:
              - sts:AssumeRole
      Policies:
        - PolicyName: PrepareRuntimeCodeBuildLogs
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource:
                  - !Sub "arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/codebuild/${EnvironmentName}-prepare-runtime"
                  - !Sub "arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/codebuild/${EnvironmentName}-prepare-runtime:*"
        - PolicyName: PrepareRuntimeCodeBuildS3
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:GetObjectVersion
                Resource: !If
                  - HasRuntimeArtifactsPrefix
                  - !Sub "arn:${AWS::Partition}:s3:::${RuntimeArtifactsBucket}/${RuntimeArtifactsPrefix}*"
                  - !Sub "arn:${AWS::Partition}:s3:::${RuntimeArtifactsBucket}/*"
              - Effect: Allow
                Action:
                  - s3:ListBucket
                Resource: !Sub "arn:${AWS::Partition}:s3:::${RuntimeArtifactsBucket}"
        - PolicyName: PrepareRuntimeCodeBuildDynamoDB
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - dynamodb:*
                Resource:
                  - !Sub "arn:${AWS::Partition}:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${ErrorsTableName}"
                  - !Sub "arn:${AWS::Partition}:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${ErrorsTableName}/index/*"
        - PolicyName: PrepareRuntimeCodeBuildS3ReadWrite
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:PutObject
                  - s3:GetObjectVersion
                Resource:
                  - !Sub "arn:${AWS::Partition}:s3:::${RuntimeArtifactsBucket}/*"
                  - "arn:aws:s3:::*/*"
              - Effect: Allow
                Action:
                  - s3:ListBucket
                Resource:
                  - !Sub "arn:${AWS::Partition}:s3:::${RuntimeArtifactsBucket}"
                  - "arn:aws:s3:::*"
        - PolicyName: PrepareRuntimeCodeBuildLambdaInvoke
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - lambda:InvokeFunction
                Resource:
                  - !Sub "arn:${AWS::Partition}:lambda:${AWS::Region}:${AWS::AccountId}:function:${TransformWorkerFunctionName}"
                  - !Sub "arn:${AWS::Partition}:lambda:${AWS::Region}:${AWS::AccountId}:function:${TransformWorkerFunctionName}:*"
                  - !Sub "arn:${AWS::Partition}:lambda:${AWS::Region}:${AWS::AccountId}:function:${SvlWorkerFunctionName}"
                  - !Sub "arn:${AWS::Partition}:lambda:${AWS::Region}:${AWS::AccountId}:function:${SvlWorkerFunctionName}:*"
                  - !Sub "arn:${AWS::Partition}:lambda:${AWS::Region}:${AWS::AccountId}:function:${MvlFunctionName}"
                  - !Sub "arn:${AWS::Partition}:lambda:${AWS::Region}:${AWS::AccountId}:function:${MvlFunctionName}:*"
                  - !Sub "arn:${AWS::Partition}:lambda:${AWS::Region}:${AWS::AccountId}:function:${GetExecutionLambdaFunctionName}"
                  - !Sub "arn:${AWS::Partition}:lambda:${AWS::Region}:${AWS::AccountId}:function:${GetExecutionLambdaFunctionName}:*"
        - PolicyName: PrepareRuntimeCodeBuildSQS
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - sqs:SendMessage
                  - sqs:GetQueueUrl
                Resource:
                  - !Sub "arn:${AWS::Partition}:sqs:${AWS::Region}:${AWS::AccountId}:*"
        - PolicyName: UseBedrockToInvokeLLM
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Sid: AllowModelAndInferenceProfileAccess
                Effect: Allow
                Action:
                  - bedrock:InvokeModel
                  - bedrock:InvokeModelWithResponseStream
                  - bedrock:ListInferenceProfiles
                Resource:
                  - arn:aws:bedrock:*:*:inference-profile/*
                  - arn:aws:bedrock:*:*:application-inference-profile/*
                  - arn:aws:bedrock:*:*:foundation-model/*
              - Sid: AllowMarketplaceSubscription
                Effect: Allow
                Action:
                  - aws-marketplace:ViewSubscriptions
                  - aws-marketplace:Subscribe
                Resource: "*"
                Condition:
                  StringEquals:
                    aws:CalledViaLast: bedrock.amazonaws.com
        - PolicyName: PrepareRuntimeCodeBuildCloudWatch
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - cloudwatch:PutMetricData
                Resource: "*"
                Condition:
                  StringEquals:
                    cloudwatch:namespace:
                      - AutoRepair
                      - ExecutionRestart
        - PolicyName: PrepareRuntimeCodeBuildEventBridge
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - events:PutEvents
                Resource: "*"
        - PolicyName: PrepareRuntimeCodeBuildStepFunctions
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - states:GetExecutionHistory
                # Execution ARN format: arn:aws:states:{region}:{account}:execution:{stateMachineName}:{executionId}
                # We need to match executions, not the stateMachine ARN directly
                Resource: !Sub "arn:aws:states:${AWS::Region}:${AWS::AccountId}:execution:*"

      Tags:
        - Key: Environment
          Value: !Ref EnvironmentName

  PrepareRuntimeCodeBuildProject:
    Type: AWS::CodeBuild::Project
    Properties:
      Name: !Sub "${EnvironmentName}-prepare-runtime"
      Description: Downloads runtime ZIP archives, extracts them, and executes the Node.js entry point.
      ServiceRole: !GetAtt PrepareRuntimeBuildRole.Arn
      Artifacts:
        Type: NO_ARTIFACTS
      TimeoutInMinutes: 60
      Environment:
        ComputeType: BUILD_GENERAL1_SMALL
        Image: aws/codebuild/amazonlinux2-aarch64-standard:3.0-25.03.03
        Type: ARM_CONTAINER
        EnvironmentVariables:
          - Name: RUNTIME_ARTIFACTS_BUCKET
            Type: PLAINTEXT
            Value: !Ref RuntimeArtifactsBucket
          - Name: RUNTIME_ARTIFACTS_PREFIX
            Type: PLAINTEXT
            Value: !Ref RuntimeArtifactsPrefix
          - Name: RUNTIME_ENTRYPOINT
            Type: PLAINTEXT
            Value: !Ref RuntimeEntryPoint
          - Name: ERRORS_TABLE_NAME
            Type: PLAINTEXT
            Value: !Ref ErrorsTableName
          - Name: TRANSFORM_S3_PREFIX
            Type: PLAINTEXT
            Value: !Ref TransformS3Prefix
          - Name: TRANSFORM_WORKER_FUNCTION_NAME
            Type: PLAINTEXT
            Value: !Ref TransformWorkerFunctionName
          - Name: SVL_WORKER_FUNCTION_NAME
            Type: PLAINTEXT
            Value: !Ref SvlWorkerFunctionName
          - Name: OUTPUT_S3_PREFIX
            Type: PLAINTEXT
            Value: !Ref OutputS3Prefix
          - Name: MVL_FUNCTION_NAME
            Type: PLAINTEXT
            Value: !Ref MvlFunctionName
          - Name: TRANSACTIONS_SQS_QUEUE_URL
            Type: PLAINTEXT
            Value: !Ref TransactionsSqsQueueUrl
          - Name: MAX_EXECUTIONS_PER_RUN
            Type: PLAINTEXT
            Value: "50"
          - Name: EXECUTION_BATCH_SIZE
            Type: PLAINTEXT
            Value: "10"
          - Name: DEFAULT_DLQ_URL
            Type: PLAINTEXT
            Value: !Ref DefaultDlqUrl
          - Name: GET_EXECUTION_LAMBDA_FUNCTION_NAME
            Type: PLAINTEXT
            Value: !Ref GetExecutionLambdaFunctionName
          - Name: STATE_MACHINE_ARN
            Type: PLAINTEXT
            Value: !Ref StateMachineArn
          - Name: AWS_REGION
            Type: PLAINTEXT
            Value: !Ref AWS::Region
      LogsConfig:
        CloudWatchLogs:
          GroupName: !Sub "/aws/codebuild/${EnvironmentName}-prepare-runtime"
          Status: ENABLED
      Source:
        Type: NO_SOURCE
        BuildSpec: |
          version: 0.2

          env:
            shell: bash

          phases:
            install:
              runtime-versions:
                nodejs: 22
              commands:
                - npm install -g cheerio
                # Install elephant-mcp from branch for testing (remove OpenAI dependency)
                # Using manual clone+build approach since npm git install has issues with build steps
                - git clone --depth 1 --branch feat/remove-openai-dependency https://github.com/elephant-xyz/elephant-mcp.git /tmp/elephant-mcp
                - cd /tmp/elephant-mcp && npm install && npm run build && npm link
                - echo "Node.js runtime set to version 22."
            pre_build:
              commands:
                - set -euo pipefail
                - export RUNTIME_DOWNLOAD_DIR="/tmp/runtime-archives"
                - export RUNTIME_WORK_DIR="/tmp/runtime-workdir"
                - mkdir -p "${RUNTIME_DOWNLOAD_DIR}" "${RUNTIME_WORK_DIR}"
                - >
                  if [[ -z "${RUNTIME_ARTIFACTS_BUCKET:-}" ]]; then
                    echo "RUNTIME_ARTIFACTS_BUCKET environment variable is required." >&2
                    exit 1
                  fi
                - >
                  S3_SOURCE="s3://${RUNTIME_ARTIFACTS_BUCKET}"
                - >
                  if [[ -n "${RUNTIME_ARTIFACTS_PREFIX:-}" ]]; then
                    S3_SOURCE="${S3_SOURCE%/}/${RUNTIME_ARTIFACTS_PREFIX}"
                  fi
                - aws s3 cp "${S3_SOURCE}" "${RUNTIME_DOWNLOAD_DIR}" --recursive --exclude "*" --include "*.zip"
                - >
                  if ! compgen -G "${RUNTIME_DOWNLOAD_DIR}/*.zip" > /dev/null; then
                    echo "No runtime zip archives found at ${S3_SOURCE}" >&2
                    exit 1
                  fi
                - |
                  for archive in "${RUNTIME_DOWNLOAD_DIR}"/*.zip; do
                    echo "Unpacking ${archive}..."
                    unzip -qo "${archive}" -d "${RUNTIME_WORK_DIR}"
                  done
                - |
                  echo $(ls -1 "${RUNTIME_WORK_DIR}")
                  cd "${RUNTIME_WORK_DIR}" && npm install
            build:
              commands:
                - cd "${RUNTIME_WORK_DIR}"
                - >
                  if [[ -z "${RUNTIME_ENTRYPOINT:-}" ]]; then
                    echo "RUNTIME_ENTRYPOINT environment variable is required." >&2
                    exit 1
                  fi
                - >
                  if [[ ! -f "${RUNTIME_ENTRYPOINT}" ]]; then
                    echo "Entry point ${RUNTIME_ENTRYPOINT} not found after extraction." >&2
                    exit 1
                  fi
                - export CLAUDE_CODE_USE_BEDROCK=1
                # Recommended output token settings for Bedrock
                - export CLAUDE_CODE_MAX_OUTPUT_TOKENS=4096
                - export MAX_THINKING_TOKENS=1024
                - export ANTHROPIC_DEFAULT_HAIKU_MODEL=us.anthropic.claude-haiku-4-5-20251001-v1:0
                - export ANTHROPIC_MODEL='global.anthropic.claude-sonnet-4-5-20250929-v1:0'
                - export ANTHROPIC_SMALL_FAST_MODEL='us.anthropic.claude-haiku-4-5-20251001-v1:0'
                - node "${RUNTIME_ENTRYPOINT}"
      Tags:
        - Key: Environment
          Value: !Ref EnvironmentName

  CodeBuildSchedulerFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "${EnvironmentName}-codebuild-scheduler"
      Runtime: nodejs22.x
      Architectures:
        - arm64
      Handler: index.handler
      CodeUri: lambdas/codebuild-scheduler
      Timeout: 60
      MemorySize: 128
      Environment:
        Variables:
          CODEBUILD_PROJECT_NAME: !Ref PrepareRuntimeCodeBuildProject
          ENABLE_AUTO_REPAIR: !Ref EnableAutoRepair
      LoggingConfig:
        LogFormat: JSON
      Policies:
        - Version: "2012-10-17"
          Statement:
            - Effect: Allow
              Action:
                - codebuild:StartBuild
                - codebuild:ListBuildsForProject
                - codebuild:BatchGetBuilds
              Resource:
                - !GetAtt PrepareRuntimeCodeBuildProject.Arn
      Events:
        ScheduledExecution:
          Type: Schedule
          Properties:
            Schedule: !Sub "rate(${AutoRepairSchedule})"
            Enabled: true
      Tags:
        Environment: !Ref EnvironmentName

  RedriveAutoRepairBuildRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: codebuild.amazonaws.com
            Action:
              - sts:AssumeRole
      Policies:
        - PolicyName: RedriveAutoRepairCodeBuildLogs
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource:
                  - !Sub "arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/codebuild/${EnvironmentName}-redrive-auto-repair"
                  - !Sub "arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/codebuild/${EnvironmentName}-redrive-auto-repair:*"
        - PolicyName: RedriveAutoRepairCodeBuildS3
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:GetObjectVersion
                  - s3:PutObject
                Resource: !If
                  - HasRuntimeArtifactsPrefix
                  - !Sub "arn:${AWS::Partition}:s3:::${RuntimeArtifactsBucket}/${RuntimeArtifactsPrefix}*"
                  - !Sub "arn:${AWS::Partition}:s3:::${RuntimeArtifactsBucket}/*"
              - Effect: Allow
                Action:
                  - s3:ListBucket
                Resource: !Sub "arn:${AWS::Partition}:s3:::${RuntimeArtifactsBucket}"
        - PolicyName: RedriveAutoRepairCodeBuildS3ReadWrite
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:PutObject
                  - s3:GetObjectVersion
                Resource:
                  - !Sub "arn:${AWS::Partition}:s3:::${RuntimeArtifactsBucket}/*"
                  - "arn:aws:s3:::*/*"
              - Effect: Allow
                Action:
                  - s3:ListBucket
                Resource:
                  - !Sub "arn:${AWS::Partition}:s3:::${RuntimeArtifactsBucket}"
                  - "arn:aws:s3:::*"
        - PolicyName: RedriveAutoRepairCodeBuildSQS
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - sqs:SendMessage
                  - sqs:GetQueueUrl
                  - sqs:GetQueueAttributes
                Resource:
                  - !Sub "arn:${AWS::Partition}:sqs:${AWS::Region}:${AWS::AccountId}:*"
        - PolicyName: RedriveAutoRepairCodeBuildSSM
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - ssm:PutParameter
                  - ssm:GetParameter
                Resource:
                  - !Sub "arn:${AWS::Partition}:ssm:${AWS::Region}:${AWS::AccountId}:parameter/elephant-oracle/auto-repair/*"
        - PolicyName: RedriveAutoRepairCodeBuildLambda
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - lambda:ListEventSourceMappings
                  - lambda:UpdateEventSourceMapping
                  - lambda:GetFunctionConfiguration
                  - lambda:UpdateFunctionConfiguration
                Resource:
                  - !Sub "arn:${AWS::Partition}:lambda:${AWS::Region}:${AWS::AccountId}:function:*"
        - PolicyName: RedriveAutoRepairCodeBuildDynamoDB
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - dynamodb:*
                Resource:
                  - !Sub "arn:${AWS::Partition}:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${ErrorsTableName}"
                  - !Sub "arn:${AWS::Partition}:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${ErrorsTableName}/index/*"
        - PolicyName: RedriveAutoRepairCodeBuildCodeBuild
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - codebuild:StartBuild
                Resource:
                  - !Sub "arn:${AWS::Partition}:codebuild:${AWS::Region}:${AWS::AccountId}:project/${EnvironmentName}-prepare-runtime"
      Tags:
        - Key: Environment
          Value: !Ref EnvironmentName

  RedriveAutoRepairCodeBuildProject:
    Type: AWS::CodeBuild::Project
    Properties:
      Name: !Sub "${EnvironmentName}-redrive-auto-repair"
      Description: Redrives failed executions from DynamoDB back to the workflow queue for auto-repair.
      ServiceRole: !GetAtt RedriveAutoRepairBuildRole.Arn
      Artifacts:
        Type: NO_ARTIFACTS
      TimeoutInMinutes: 480
      Environment:
        ComputeType: BUILD_GENERAL1_SMALL
        Image: aws/codebuild/amazonlinux2-aarch64-standard:3.0-25.03.03
        Type: ARM_CONTAINER
        EnvironmentVariables:
          - Name: RUNTIME_ARTIFACTS_BUCKET
            Type: PLAINTEXT
            Value: !Ref RuntimeArtifactsBucket
          - Name: RUNTIME_ARTIFACTS_PREFIX
            Type: PLAINTEXT
            Value: "codebuild/redrive-auto-repair"
          - Name: RUNTIME_ENTRYPOINT
            Type: PLAINTEXT
            Value: index.js
          - Name: ERRORS_TABLE_NAME
            Type: PLAINTEXT
            Value: !Ref ErrorsTableName
          - Name: TRANSFORM_S3_PREFIX
            Type: PLAINTEXT
            Value: !Ref TransformS3Prefix
          - Name: OUTPUT_BASE_URI
            Type: PLAINTEXT
            Value: !Ref OutputBaseUri
          - Name: AUTO_REPAIR_CODEBUILD_PROJECT
            Type: PLAINTEXT
            Value: !Sub "${EnvironmentName}-prepare-runtime"
          - Name: MAX_EXECUTIONS_PER_RUN
            Type: PLAINTEXT
            Value: !Ref MaxExecutionsPerRun
          - Name: ENABLE_AUTO_REPAIR
            Type: PLAINTEXT
            Value: !Ref EnableAutoRepair
          - Name: WORKFLOW_SQS_QUEUE_URL
            Type: PLAINTEXT
            Value: !Ref WorkflowSqsQueueUrl
          - Name: AUTO_REPAIR_SCHEDULER_FUNCTION_NAME
            Type: PLAINTEXT
            Value: !Ref CodeBuildSchedulerFunction
          - Name: CONCURRENCY
            Type: PLAINTEXT
            Value: !Ref Concurrency
      LogsConfig:
        CloudWatchLogs:
          GroupName: !Sub "/aws/codebuild/${EnvironmentName}-redrive-auto-repair"
          Status: ENABLED
      Source:
        Type: NO_SOURCE
        BuildSpec: |
          version: 0.2

          env:
            shell: bash

          phases:
            install:
              runtime-versions:
                nodejs: 22
              commands:
                - echo "Node.js runtime set to version 22."
            pre_build:
              commands:
                - set -euo pipefail
                - export RUNTIME_DOWNLOAD_DIR="/tmp/runtime-archives"
                - export RUNTIME_WORK_DIR="/tmp/runtime-workdir"
                - mkdir -p "${RUNTIME_DOWNLOAD_DIR}" "${RUNTIME_WORK_DIR}"
                - >
                  if [[ -z "${RUNTIME_ARTIFACTS_BUCKET:-}" ]]; then
                    echo "RUNTIME_ARTIFACTS_BUCKET environment variable is required." >&2
                    exit 1
                  fi
                - >
                  S3_SOURCE="s3://${RUNTIME_ARTIFACTS_BUCKET}"
                - >
                  if [[ -n "${RUNTIME_ARTIFACTS_PREFIX:-}" ]]; then
                    S3_SOURCE="${S3_SOURCE%/}/${RUNTIME_ARTIFACTS_PREFIX}"
                  fi
                - aws s3 cp "${S3_SOURCE}" "${RUNTIME_DOWNLOAD_DIR}" --recursive --exclude "*" --include "*.zip"
                - >
                  if ! compgen -G "${RUNTIME_DOWNLOAD_DIR}/*.zip" > /dev/null; then
                    echo "No runtime zip archives found at ${S3_SOURCE}" >&2
                    exit 1
                  fi
                - |
                  for archive in "${RUNTIME_DOWNLOAD_DIR}"/*.zip; do
                    echo "Unpacking ${archive}..."
                    unzip -qo "${archive}" -d "${RUNTIME_WORK_DIR}"
                  done
                - |
                  echo $(ls -1 "${RUNTIME_WORK_DIR}")
                  cd "${RUNTIME_WORK_DIR}" && npm install
            build:
              commands:
                - cd "${RUNTIME_WORK_DIR}"
                - >
                  if [[ -z "${RUNTIME_ENTRYPOINT:-}" ]]; then
                    echo "RUNTIME_ENTRYPOINT environment variable is required." >&2
                    exit 1
                  fi
                - >
                  if [[ ! -f "${RUNTIME_ENTRYPOINT}" ]]; then
                    echo "Entry point ${RUNTIME_ENTRYPOINT} not found after extraction." >&2
                    exit 1
                  fi
                - node "${RUNTIME_ENTRYPOINT}"
      Tags:
        - Key: Environment
          Value: !Ref EnvironmentName

  RedriveAutoRepairCodeBuildSchedulerFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "${EnvironmentName}-redrive-auto-repair-codebuild-scheduler"
      Runtime: nodejs22.x
      Architectures:
        - arm64
      Handler: index.handler
      CodeUri: lambdas/codebuild-scheduler
      Timeout: 60
      MemorySize: 128
      Environment:
        Variables:
          CODEBUILD_PROJECT_NAME: !Ref RedriveAutoRepairCodeBuildProject
      LoggingConfig:
        LogFormat: JSON
      Policies:
        - Version: "2012-10-17"
          Statement:
            - Effect: Allow
              Action:
                - codebuild:StartBuild
                - codebuild:ListBuildsForProject
                - codebuild:BatchGetBuilds
              Resource:
                - !GetAtt RedriveAutoRepairCodeBuildProject.Arn
      Events:
        ScheduledExecution:
          Type: Schedule
          Properties:
            Schedule: rate(30 minutes)
            Enabled: false
      Tags:
        Environment: !Ref EnvironmentName

  # =============================================================================
  # GS3 Migration CodeBuild Job
  # =============================================================================
  # This job migrates ErrorRecord items to use a separate GS3 partition key
  # from FailedExecutionItem records. This is a one-time migration that must
  # be triggered manually.
  #
  # Migration Details:
  # - Before: ErrorRecord GS3PK = "METRIC#ERRORCOUNT"
  # - After:  ErrorRecord GS3PK = "METRIC#ERRORCOUNT#ERROR"
  #
  # The migration is idempotent - running it multiple times is safe.
  # =============================================================================

  GS3MigrationBuildRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: codebuild.amazonaws.com
            Action:
              - sts:AssumeRole
      Policies:
        - PolicyName: GS3MigrationCodeBuildLogs
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource:
                  - !Sub "arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/codebuild/${EnvironmentName}-gs3-migration"
                  - !Sub "arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/codebuild/${EnvironmentName}-gs3-migration:*"
        - PolicyName: GS3MigrationCodeBuildS3
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:GetObjectVersion
                Resource:
                  # GS3 migration artifacts are stored at codebuild/gs3-migration/
                  - !Sub "arn:${AWS::Partition}:s3:::${RuntimeArtifactsBucket}/codebuild/gs3-migration/*"
              - Effect: Allow
                Action:
                  - s3:ListBucket
                Resource: !Sub "arn:${AWS::Partition}:s3:::${RuntimeArtifactsBucket}"
        - PolicyName: GS3MigrationCodeBuildDynamoDB
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - dynamodb:Scan
                  - dynamodb:UpdateItem
                Resource:
                  - !Sub "arn:${AWS::Partition}:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${ErrorsTableName}"
                  - !Sub "arn:${AWS::Partition}:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${ErrorsTableName}/index/*"
      Tags:
        - Key: Environment
          Value: !Ref EnvironmentName

  GS3MigrationCodeBuildProject:
    Type: AWS::CodeBuild::Project
    Properties:
      Name: !Sub "${EnvironmentName}-gs3-migration"
      Description: "One-time migration to update ErrorRecord GS3PK for partition-level separation. Trigger manually."
      ServiceRole: !GetAtt GS3MigrationBuildRole.Arn
      Artifacts:
        Type: NO_ARTIFACTS
      TimeoutInMinutes: 120
      Environment:
        ComputeType: BUILD_GENERAL1_SMALL
        Image: aws/codebuild/amazonlinux2-aarch64-standard:3.0-25.03.03
        Type: ARM_CONTAINER
        EnvironmentVariables:
          - Name: RUNTIME_ARTIFACTS_BUCKET
            Type: PLAINTEXT
            Value: !Ref RuntimeArtifactsBucket
          - Name: RUNTIME_ARTIFACTS_PREFIX
            Type: PLAINTEXT
            Value: "codebuild/gs3-migration"
          - Name: RUNTIME_ENTRYPOINT
            Type: PLAINTEXT
            Value: index.js
          - Name: ERRORS_TABLE_NAME
            Type: PLAINTEXT
            Value: !Ref ErrorsTableName
          - Name: DRY_RUN
            Type: PLAINTEXT
            Value: "false"
      LogsConfig:
        CloudWatchLogs:
          GroupName: !Sub "/aws/codebuild/${EnvironmentName}-gs3-migration"
          Status: ENABLED
      Source:
        Type: NO_SOURCE
        BuildSpec: |
          version: 0.2

          env:
            shell: bash

          phases:
            install:
              runtime-versions:
                nodejs: 22
              commands:
                - echo "Node.js runtime set to version 22."
            pre_build:
              commands:
                - set -euo pipefail
                - export RUNTIME_DOWNLOAD_DIR="/tmp/runtime-archives"
                - export RUNTIME_WORK_DIR="/tmp/runtime-workdir"
                - mkdir -p "${RUNTIME_DOWNLOAD_DIR}" "${RUNTIME_WORK_DIR}"
                - >
                  if [[ -z "${RUNTIME_ARTIFACTS_BUCKET:-}" ]]; then
                    echo "RUNTIME_ARTIFACTS_BUCKET environment variable is required." >&2
                    exit 1
                  fi
                - >
                  S3_SOURCE="s3://${RUNTIME_ARTIFACTS_BUCKET}"
                - >
                  if [[ -n "${RUNTIME_ARTIFACTS_PREFIX:-}" ]]; then
                    S3_SOURCE="${S3_SOURCE%/}/${RUNTIME_ARTIFACTS_PREFIX}"
                  fi
                - |
                  echo "============================================================"
                  echo "  GS3 Migration Job"
                  echo "============================================================"
                  echo "  Table: ${ERRORS_TABLE_NAME}"
                  echo "  Dry Run: ${DRY_RUN}"
                  echo "  Source: ${S3_SOURCE}"
                  echo "============================================================"
                - aws s3 cp "${S3_SOURCE}" "${RUNTIME_DOWNLOAD_DIR}" --recursive --exclude "*" --include "*.zip"
                - >
                  if ! compgen -G "${RUNTIME_DOWNLOAD_DIR}/*.zip" > /dev/null; then
                    echo "No runtime zip archives found at ${S3_SOURCE}" >&2
                    exit 1
                  fi
                - |
                  for archive in "${RUNTIME_DOWNLOAD_DIR}"/*.zip; do
                    echo "Unpacking ${archive}..."
                    unzip -qo "${archive}" -d "${RUNTIME_WORK_DIR}"
                  done
                - |
                  echo $(ls -1 "${RUNTIME_WORK_DIR}")
                  cd "${RUNTIME_WORK_DIR}" && npm install
            build:
              commands:
                - cd "${RUNTIME_WORK_DIR}"
                - >
                  if [[ -z "${RUNTIME_ENTRYPOINT:-}" ]]; then
                    echo "RUNTIME_ENTRYPOINT environment variable is required." >&2
                    exit 1
                  fi
                - >
                  if [[ ! -f "${RUNTIME_ENTRYPOINT}" ]]; then
                    echo "Entry point ${RUNTIME_ENTRYPOINT} not found after extraction." >&2
                    exit 1
                  fi
                - node "${RUNTIME_ENTRYPOINT}"
            post_build:
              commands:
                - echo "GS3 Migration Job Complete"
      Tags:
        - Key: Environment
          Value: !Ref EnvironmentName

  # =============================================================================
  # Orphaned Executions Cleanup CodeBuild Job
  # =============================================================================
  # This job identifies and deletes orphaned FailedExecutionItem records that have
  # no corresponding ExecutionErrorLink records. This situation can occur when
  # EventBridge retries a WorkflowEvent after a Lambda timeout, causing duplicate
  # processing and inflated counts.
  #
  # Detection Criteria:
  # - entityType = "FailedExecution"
  # - openErrorCount > 0
  # - No ExecutionErrorLink records exist (SK begins_with "ERROR#" returns 0)
  #
  # The migration is idempotent - running it multiple times is safe.
  # =============================================================================

  OrphanedExecutionsCleanupBuildRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: codebuild.amazonaws.com
            Action:
              - sts:AssumeRole
      Policies:
        - PolicyName: OrphanedExecutionsCleanupCodeBuildLogs
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource:
                  - !Sub "arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/codebuild/${EnvironmentName}-orphaned-executions-cleanup"
                  - !Sub "arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/codebuild/${EnvironmentName}-orphaned-executions-cleanup:*"
        - PolicyName: OrphanedExecutionsCleanupCodeBuildS3
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:GetObjectVersion
                Resource:
                  - !Sub "arn:${AWS::Partition}:s3:::${RuntimeArtifactsBucket}/codebuild/orphaned-executions-cleanup/*"
              - Effect: Allow
                Action:
                  - s3:ListBucket
                Resource: !Sub "arn:${AWS::Partition}:s3:::${RuntimeArtifactsBucket}"
        - PolicyName: OrphanedExecutionsCleanupCodeBuildDynamoDB
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - dynamodb:Scan
                  - dynamodb:Query
                  - dynamodb:DeleteItem
                  - dynamodb:BatchGetItem
                Resource:
                  - !Sub "arn:${AWS::Partition}:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${ErrorsTableName}"
                  - !Sub "arn:${AWS::Partition}:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${ErrorsTableName}/index/*"
      Tags:
        - Key: Environment
          Value: !Ref EnvironmentName

  OrphanedExecutionsCleanupCodeBuildProject:
    Type: AWS::CodeBuild::Project
    Properties:
      Name: !Sub "${EnvironmentName}-orphaned-executions-cleanup"
      Description: "One-time cleanup of orphaned FailedExecutionItem records with no error links. Trigger manually."
      ServiceRole: !GetAtt OrphanedExecutionsCleanupBuildRole.Arn
      Artifacts:
        Type: NO_ARTIFACTS
      TimeoutInMinutes: 120
      Environment:
        ComputeType: BUILD_GENERAL1_SMALL
        Image: aws/codebuild/amazonlinux2-aarch64-standard:3.0-25.03.03
        Type: ARM_CONTAINER
        EnvironmentVariables:
          - Name: RUNTIME_ARTIFACTS_BUCKET
            Type: PLAINTEXT
            Value: !Ref RuntimeArtifactsBucket
          - Name: RUNTIME_ARTIFACTS_PREFIX
            Type: PLAINTEXT
            Value: "codebuild/orphaned-executions-cleanup"
          - Name: RUNTIME_ENTRYPOINT
            Type: PLAINTEXT
            Value: index.js
          - Name: ERRORS_TABLE_NAME
            Type: PLAINTEXT
            Value: !Ref ErrorsTableName
          - Name: DRY_RUN
            Type: PLAINTEXT
            Value: "true"
      LogsConfig:
        CloudWatchLogs:
          GroupName: !Sub "/aws/codebuild/${EnvironmentName}-orphaned-executions-cleanup"
          Status: ENABLED
      Source:
        Type: NO_SOURCE
        BuildSpec: |
          version: 0.2

          env:
            shell: bash

          phases:
            install:
              runtime-versions:
                nodejs: 22
              commands:
                - echo "Node.js runtime set to version 22."
            pre_build:
              commands:
                - set -euo pipefail
                - export RUNTIME_DOWNLOAD_DIR="/tmp/runtime-archives"
                - export RUNTIME_WORK_DIR="/tmp/runtime-workdir"
                - mkdir -p "${RUNTIME_DOWNLOAD_DIR}" "${RUNTIME_WORK_DIR}"
                - >
                  if [[ -z "${RUNTIME_ARTIFACTS_BUCKET:-}" ]]; then
                    echo "RUNTIME_ARTIFACTS_BUCKET environment variable is required." >&2
                    exit 1
                  fi
                - >
                  S3_SOURCE="s3://${RUNTIME_ARTIFACTS_BUCKET}"
                - >
                  if [[ -n "${RUNTIME_ARTIFACTS_PREFIX:-}" ]]; then
                    S3_SOURCE="${S3_SOURCE%/}/${RUNTIME_ARTIFACTS_PREFIX}"
                  fi
                - |
                  echo "============================================================"
                  echo "  Orphaned Executions Cleanup Job"
                  echo "============================================================"
                  echo "  Table: ${ERRORS_TABLE_NAME}"
                  echo "  Dry Run: ${DRY_RUN}"
                  echo "  Source: ${S3_SOURCE}"
                  echo "============================================================"
                - aws s3 cp "${S3_SOURCE}" "${RUNTIME_DOWNLOAD_DIR}" --recursive --exclude "*" --include "*.zip"
                - >
                  if ! compgen -G "${RUNTIME_DOWNLOAD_DIR}/*.zip" > /dev/null; then
                    echo "No runtime zip archives found at ${S3_SOURCE}" >&2
                    exit 1
                  fi
                - |
                  for archive in "${RUNTIME_DOWNLOAD_DIR}"/*.zip; do
                    echo "Unpacking ${archive}..."
                    unzip -qo "${archive}" -d "${RUNTIME_WORK_DIR}"
                  done
                - |
                  echo $(ls -1 "${RUNTIME_WORK_DIR}")
                  cd "${RUNTIME_WORK_DIR}" && npm install
            build:
              commands:
                - cd "${RUNTIME_WORK_DIR}"
                - >
                  if [[ -z "${RUNTIME_ENTRYPOINT:-}" ]]; then
                    echo "RUNTIME_ENTRYPOINT environment variable is required." >&2
                    exit 1
                  fi
                - >
                  if [[ ! -f "${RUNTIME_ENTRYPOINT}" ]]; then
                    echo "Entry point ${RUNTIME_ENTRYPOINT} not found after extraction." >&2
                    exit 1
                  fi
                - node "${RUNTIME_ENTRYPOINT}"
            post_build:
              commands:
                - echo "Orphaned Executions Cleanup Job Complete"
      Tags:
        - Key: Environment
          Value: !Ref EnvironmentName

  # =============================================================================
  # Workflow Direct Submit CodeBuild Job
  # =============================================================================
  # This job drains messages from the transactions queues (main and DLQ) and
  # moves them to the workflow queue for processing in "direct submit" mode,
  # bypassing all mining operations (prepare, transform, svl, hash, upload).
  #
  # Usage:
  # - Triggered manually via AWS Console or CLI
  # - Reads TRANSACTIONS_QUEUE_URL, TRANSACTIONS_DLQ_URL, and WORKFLOW_QUEUE_URL
  # - Only processes messages WITHOUT ExecutionArn attribute
  # - Messages WITH ExecutionArn are left in queue (belong to running workflows)
  # - Moves filtered messages to workflow queue in direct-submit format
  # =============================================================================

  WorkflowDirectSubmitBuildRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: codebuild.amazonaws.com
            Action:
              - sts:AssumeRole
      Policies:
        - PolicyName: WorkflowDirectSubmitCodeBuildLogs
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource:
                  - !Sub "arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/codebuild/${EnvironmentName}-workflow-direct-submit"
                  - !Sub "arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/codebuild/${EnvironmentName}-workflow-direct-submit:*"
        - PolicyName: WorkflowDirectSubmitCodeBuildS3
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:GetObjectVersion
                Resource:
                  # Direct submit artifacts are stored at codebuild/workflow-direct-submit/
                  - !Sub "arn:${AWS::Partition}:s3:::${RuntimeArtifactsBucket}/codebuild/workflow-direct-submit/*"
              - Effect: Allow
                Action:
                  - s3:ListBucket
                Resource: !Sub "arn:${AWS::Partition}:s3:::${RuntimeArtifactsBucket}"
        - PolicyName: WorkflowDirectSubmitCodeBuildSQS
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - sqs:ReceiveMessage
                  - sqs:DeleteMessage
                  - sqs:GetQueueAttributes
                  - sqs:GetQueueUrl
                Resource:
                  - !Sub "arn:${AWS::Partition}:sqs:${AWS::Region}:${AWS::AccountId}:*"
        - PolicyName: WorkflowDirectSubmitCodeBuildSQSSend
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - sqs:SendMessage
                Resource:
                  # Allow sending to workflow queue (derived from URL)
                  - !Sub "arn:${AWS::Partition}:sqs:${AWS::Region}:${AWS::AccountId}:*"
      Tags:
        - Key: Environment
          Value: !Ref EnvironmentName

  WorkflowDirectSubmitCodeBuildProject:
    Type: AWS::CodeBuild::Project
    Properties:
      Name: !Sub "${EnvironmentName}-workflow-direct-submit"
      Description: "Drains transactions queues and moves messages to workflow queue for direct-submit processing. Trigger manually."
      ServiceRole: !GetAtt WorkflowDirectSubmitBuildRole.Arn
      Artifacts:
        Type: NO_ARTIFACTS
      TimeoutInMinutes: 480
      Environment:
        ComputeType: BUILD_GENERAL1_SMALL
        Image: aws/codebuild/amazonlinux2-aarch64-standard:3.0-25.03.03
        Type: ARM_CONTAINER
        EnvironmentVariables:
          - Name: RUNTIME_ARTIFACTS_BUCKET
            Type: PLAINTEXT
            Value: !Ref RuntimeArtifactsBucket
          - Name: RUNTIME_ARTIFACTS_PREFIX
            Type: PLAINTEXT
            Value: "codebuild/workflow-direct-submit"
          - Name: RUNTIME_ENTRYPOINT
            Type: PLAINTEXT
            Value: index.js
          - Name: TRANSACTIONS_QUEUE_URL
            Type: PLAINTEXT
            Value: !Ref TransactionsSqsQueueUrl
          - Name: TRANSACTIONS_DLQ_URL
            Type: PLAINTEXT
            Value: !Ref TransactionsDeadLetterQueueUrl
          - Name: WORKFLOW_QUEUE_URL
            Type: PLAINTEXT
            Value: !Ref WorkflowSqsQueueUrl
          - Name: PROCESS_ONLY_DLQ
            Type: PLAINTEXT
            Value: "false"
          - Name: PROCESS_ONLY_MAIN
            Type: PLAINTEXT
            Value: "false"
      LogsConfig:
        CloudWatchLogs:
          GroupName: !Sub "/aws/codebuild/${EnvironmentName}-workflow-direct-submit"
          Status: ENABLED
      Source:
        Type: NO_SOURCE
        BuildSpec: |
          version: 0.2

          env:
            shell: bash

          phases:
            install:
              runtime-versions:
                nodejs: 22
              commands:
                - echo "Node.js runtime set to version 22."
            pre_build:
              commands:
                - set -euo pipefail
                - export RUNTIME_DOWNLOAD_DIR="/tmp/runtime-archives"
                - export RUNTIME_WORK_DIR="/tmp/runtime-workdir"
                - mkdir -p "${RUNTIME_DOWNLOAD_DIR}" "${RUNTIME_WORK_DIR}"
                - >
                  if [[ -z "${RUNTIME_ARTIFACTS_BUCKET:-}" ]]; then
                    echo "RUNTIME_ARTIFACTS_BUCKET environment variable is required." >&2
                    exit 1
                  fi
                - >
                  S3_SOURCE="s3://${RUNTIME_ARTIFACTS_BUCKET}"
                - >
                  if [[ -n "${RUNTIME_ARTIFACTS_PREFIX:-}" ]]; then
                    S3_SOURCE="${S3_SOURCE%/}/${RUNTIME_ARTIFACTS_PREFIX}"
                  fi
                - |
                  echo "============================================================"
                  echo "  Workflow Direct Submit Job"
                  echo "============================================================"
                  echo "  Transactions Queue URL: ${TRANSACTIONS_QUEUE_URL}"
                  echo "  Transactions DLQ URL: ${TRANSACTIONS_DLQ_URL}"
                  echo "  Workflow Queue URL: ${WORKFLOW_QUEUE_URL}"
                  echo "  Process Only DLQ: ${PROCESS_ONLY_DLQ}"
                  echo "  Process Only Main: ${PROCESS_ONLY_MAIN}"
                  echo "  Source: ${S3_SOURCE}"
                  echo "============================================================"
                - aws s3 cp "${S3_SOURCE}" "${RUNTIME_DOWNLOAD_DIR}" --recursive --exclude "*" --include "*.zip"
                - >
                  if ! compgen -G "${RUNTIME_DOWNLOAD_DIR}/*.zip" > /dev/null; then
                    echo "No runtime zip archives found at ${S3_SOURCE}" >&2
                    exit 1
                  fi
                - |
                  for archive in "${RUNTIME_DOWNLOAD_DIR}"/*.zip; do
                    echo "Unpacking ${archive}..."
                    unzip -qo "${archive}" -d "${RUNTIME_WORK_DIR}"
                  done
                - |
                  echo $(ls -1 "${RUNTIME_WORK_DIR}")
                  cd "${RUNTIME_WORK_DIR}" && npm install
            build:
              commands:
                - cd "${RUNTIME_WORK_DIR}"
                - >
                  if [[ -z "${RUNTIME_ENTRYPOINT:-}" ]]; then
                    echo "RUNTIME_ENTRYPOINT environment variable is required." >&2
                    exit 1
                  fi
                - >
                  if [[ ! -f "${RUNTIME_ENTRYPOINT}" ]]; then
                    echo "Entry point ${RUNTIME_ENTRYPOINT} not found after extraction." >&2
                    exit 1
                  fi
                - node "${RUNTIME_ENTRYPOINT}"
            post_build:
              commands:
                - echo "Workflow Direct Submit Job Complete"
      Tags:
        - Key: Environment
          Value: !Ref EnvironmentName

Outputs:
  PrepareRuntimeCodeBuildProjectName:
    Description: Name of the CodeBuild project that prepares runtime assets
    Value: !Ref PrepareRuntimeCodeBuildProject
  PrepareRuntimeCodeBuildProjectArn:
    Description: ARN of the CodeBuild project that prepares runtime assets
    Value: !GetAtt PrepareRuntimeCodeBuildProject.Arn
  CodeBuildSchedulerFunctionName:
    Description: Name of the Lambda function that schedules CodeBuild executions
    Value: !Ref CodeBuildSchedulerFunction
  CodeBuildSchedulerFunctionArn:
    Description: ARN of the Lambda function that schedules CodeBuild executions
    Value: !GetAtt CodeBuildSchedulerFunction.Arn
  AutoRepairSchedule:
    Description: Current schedule expression for auto-repair execution
    Value: !Ref AutoRepairSchedule
  RedriveAutoRepairCodeBuildProjectName:
    Description: Name of the CodeBuild project for redrive auto repair workflow
    Value: !Ref RedriveAutoRepairCodeBuildProject
  RedriveAutoRepairCodeBuildProjectArn:
    Description: ARN of the CodeBuild project for redrive auto repair workflow
    Value: !GetAtt RedriveAutoRepairCodeBuildProject.Arn
  RedriveAutoRepairCodeBuildSchedulerFunctionName:
    Description: Name of the Lambda function that schedules redrive auto repair CodeBuild executions
    Value: !Ref RedriveAutoRepairCodeBuildSchedulerFunction
  RedriveAutoRepairCodeBuildSchedulerFunctionArn:
    Description: ARN of the Lambda function that schedules redrive auto repair CodeBuild executions
    Value: !GetAtt RedriveAutoRepairCodeBuildSchedulerFunction.Arn
  GS3MigrationCodeBuildProjectName:
    Description: Name of the CodeBuild project for GS3 partition key migration (manual trigger only)
    Value: !Ref GS3MigrationCodeBuildProject
  GS3MigrationCodeBuildProjectArn:
    Description: ARN of the CodeBuild project for GS3 partition key migration
    Value: !GetAtt GS3MigrationCodeBuildProject.Arn
  OrphanedExecutionsCleanupCodeBuildProjectName:
    Description: Name of the CodeBuild project for orphaned executions cleanup (manual trigger only)
    Value: !Ref OrphanedExecutionsCleanupCodeBuildProject
  OrphanedExecutionsCleanupCodeBuildProjectArn:
    Description: ARN of the CodeBuild project for orphaned executions cleanup
    Value: !GetAtt OrphanedExecutionsCleanupCodeBuildProject.Arn
  WorkflowDirectSubmitCodeBuildProjectName:
    Description: Name of the CodeBuild project for workflow direct submit (manual trigger only)
    Value: !Ref WorkflowDirectSubmitCodeBuildProject
  WorkflowDirectSubmitCodeBuildProjectArn:
    Description: ARN of the CodeBuild project for workflow direct submit
    Value: !GetAtt WorkflowDirectSubmitCodeBuildProject.Arn
