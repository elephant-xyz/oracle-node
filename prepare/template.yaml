AWSTemplateFormatVersion: "2010-09-09"
Transform: AWS::Serverless-2016-10-31
Description: Unified SAM template defining downloader/updater Lambdas + AWS Step Functions (Standard) workflow with SQS and Lambda

Parameters:
  EnvironmentName:
    Description: An environment name that is prefixed to resource names
    Type: String
    Default: MWAAEnvironment

  # Parameters for new Step Functions workflow (replaces Airflow UI variables as deployment inputs)
  ElephantDomain:
    Description: Elephant API domain for submit step
    Type: String
    Default: ""
  ElephantApiKey:
    Description: Elephant API key
    Type: String
    NoEcho: true
    Default: ""
  ElephantOracleKeyId:
    Description: Elephant oracle key id
    Type: String
    Default: ""
  ElephantFromAddress:
    Description: From address for blockchain submission
    Type: String
    Default: ""
  ElephantRpcUrl:
    Description: RPC URL for blockchain submission
    Type: String
    Default: ""
  ElephantPinataJwt:
    Description: Pinata JWT for uploads
    Type: String
    NoEcho: true
    Default: ""
  TransformS3Prefix:
    Description: S3 URI prefix containing county transform archives
    Type: String
  ElephantKeystoreS3Key:
    Description: S3 key for keystore JSON file (when using keystore mode)
    Type: String
    Default: ""
  ElephantKeystorePassword:
    Description: Password for keystore file (when using keystore mode)
    Type: String
    NoEcho: true
    Default: ""
  WorkflowQueueName:
    Description: Name for the Step Functions SQS trigger queue
    Type: String
    Default: elephant-workflow-queue
  WorkflowStarterReservedConcurrency:
    Description: Max concurrent Lambda invocations and Step Function executions (since Lambda waits for completion, this controls both)
    Type: Number
    Default: 100
  MaxRunningExecutions:
    Description: Maximum number of running executions to check when enforcing concurrency limits (used for ListExecutions maxResults)
    Type: Number
    Default: 1000
  WorkflowStateMachineName:
    Description: Name for the Standard Step Functions state machine (leave empty for auto-generated name, useful when updating Type to allow replacement)
    Type: String
    Default: ElephantStandardWorkflow

  # Prepare function flags (only applied if set to 'true')
  ElephantPrepareUseBrowser:
    Description: Force browser mode for prepare function
    Type: String
    Default: "false"
    AllowedValues:
      - "true"
      - "false"
  ElephantPrepareNoFast:
    Description: Disable fast mode for prepare function
    Type: String
    Default: "false"
    AllowedValues:
      - "true"
      - "false"
  ElephantPrepareNoContinue:
    Description: Disable continue mode for prepare function
    Type: String
    Default: "false"
    AllowedValues:
      - "true"
      - "false"
  ElephantPrepareIgnoreCaptcha:
    Description: Ignore captcha challenges for prepare function
    Type: String
    Default: "false"
    AllowedValues:
      - "true"
      - "false"

  ElephantPrepareContinueButton:
    Description: CSS selector for continue button in prepare function
    Type: String
    Default: ""

  ElephantPrepareBrowserFlowTemplate:
    Description: Browser flow template for prepare function (must be provided with ElephantPrepareBrowserFlowParameters)
    Type: String
    Default: ""
  ElephantPrepareBrowserFlowParameters:
    Description: Browser flow parameters JSON for prepare function (must be provided with ElephantPrepareBrowserFlowTemplate)
    Type: String
    Default: ""

  UpdaterScheduleRate:
    Description: How often the updater function runs (e.g., '1 minute', '5 minutes', or 'cron(*/1 * * * ? *)' for every minute)
    Type: String
    Default: "1 minute"
    AllowedPattern: "^([0-9]+ (minute|minutes|hour|hours|day|days)|cron\\(.+\\))$"

  GitHubToken:
    Description: GitHub personal access token for repository sync (required)
    Type: String
    NoEcho: true

Conditions:
  IsRateExpression:
    !Not [!Equals [!Select [0, !Split ["(", !Ref UpdaterScheduleRate]], "cron"]]

Globals:
  Function:
    Timeout: 300
    Tracing: Active

Resources:
  #####################################################################################################################
  # GitHub Token Secret
  #####################################################################################################################

  GitHubTokenSecret:
    Type: AWS::SecretsManager::Secret
    Properties:
      Name: !Sub "${AWS::StackName}-github-token"
      Description: GitHub personal access token for repository sync
      SecretString: !Sub |
        {"token":"${GitHubToken}"}

  #####################################################################################################################
  # EnvironmentBucket
  #####################################################################################################################

  EnvironmentBucket:
    Type: AWS::S3::Bucket
    Properties:
      # LifecycleConfiguration:
      #   Rules:
      #     - Id: DeleteOutputs
      #       Status: Enabled
      #       ExpirationInDays: 14
      #       Prefix: outputs/
      VersioningConfiguration:
        Status: Enabled
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true

  #####################################################################################################################
  # SQS (DLQ + primary) + QueuePolicy for S3 events
  #####################################################################################################################

  MwaaDeadLetterQueue:
    Type: AWS::SQS::Queue
    Properties:
      MessageRetentionPeriod: 1209600
      VisibilityTimeout: 300
      SqsManagedSseEnabled: true
      Tags:
        - Key: Environment
          Value: !Ref EnvironmentName

  MwaaSqsQueue:
    Type: AWS::SQS::Queue
    Properties:
      VisibilityTimeout: 300
      MessageRetentionPeriod: 1209600
      SqsManagedSseEnabled: true
      RedrivePolicy:
        deadLetterTargetArn: !GetAtt MwaaDeadLetterQueue.Arn
        maxReceiveCount: 3
      Tags:
        - Key: Environment
          Value: !Ref EnvironmentName

  MwaaSqsQueuePolicy:
    Type: AWS::SQS::QueuePolicy
    Properties:
      Queues:
        - !Ref MwaaSqsQueue
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Sid: AllowS3ToSendMessage
            Effect: Allow
            Principal:
              Service: s3.amazonaws.com
            Action:
              - sqs:SendMessage
            Resource: !GetAtt MwaaSqsQueue.Arn

  #####################################################################################################################
  # Serverless Functions
  #####################################################################################################################
  DownloaderFunction:
    Type: AWS::Serverless::Function
    Properties:
      Runtime: nodejs22.x
      EphemeralStorage:
        Size: 1024
      MemorySize: 768
      CodeUri: lambdas/downloader
      Handler: index.handler
      Description: "Downloads data (granted full S3 access as requested)"
      LoggingConfig:
        LogFormat: JSON
      Environment:
        Variables:
          ELEPHANT_PREPARE_USE_BROWSER: !Ref ElephantPrepareUseBrowser
          ELEPHANT_PREPARE_NO_FAST: !Ref ElephantPrepareNoFast
          ELEPHANT_PREPARE_NO_CONTINUE: !Ref ElephantPrepareNoContinue
          ELEPHANT_PREPARE_IGNORE_CAPTCHA: !Ref ElephantPrepareIgnoreCaptcha
          ELEPHANT_PREPARE_CONTINUE_BUTTON: !Ref ElephantPrepareContinueButton
          ELEPHANT_PREPARE_BROWSER_FLOW_TEMPLATE: !Ref ElephantPrepareBrowserFlowTemplate
          ELEPHANT_PREPARE_BROWSER_FLOW_PARAMETERS: !Ref ElephantPrepareBrowserFlowParameters
          ENVIRONMENT_BUCKET: !Ref EnvironmentBucket
          PROXY_ROTATION_TABLE_NAME: !Ref ProxyRotationTable
      Policies:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
        - arn:aws:iam::aws:policy/AmazonS3FullAccess
        - Version: "2012-10-17"
          Statement:
            - Effect: Allow
              Action:
                - dynamodb:Query
                - dynamodb:GetItem
                - dynamodb:PutItem
                - dynamodb:UpdateItem
              Resource:
                - !GetAtt ProxyRotationTable.Arn
                - !Sub "${ProxyRotationTable.Arn}/index/*"

  UpdaterFunction:
    Type: AWS::Serverless::Function
    Properties:
      Runtime: nodejs22.x
      MemorySize: 128
      CodeUri: lambdas/updater
      Handler: index.handler
      Architectures:
        - arm64
      Description: "Updates env var on DownloaderFunction and runs every minute."
      LoggingConfig:
        LogFormat: JSON
      Environment:
        Variables:
          TARGET_FUNCTION_NAME: !Ref DownloaderFunction
          VAR_NAME: DEPLOY_TS
      Policies:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
        - arn:aws:iam::aws:policy/AmazonS3FullAccess
        - Version: "2012-10-17"
          Statement:
            - Effect: Allow
              Action:
                - lambda:GetFunctionConfiguration
                - lambda:UpdateFunctionConfiguration
              Resource: !GetAtt DownloaderFunction.Arn
      Events:
        UpdateSchedule:
          Type: Schedule
          Properties:
            Name: UpdateDownloaderSchedule
            Description: !Sub "Invoke updater every ${UpdaterScheduleRate} to refresh env var."
            Schedule: !If
              - IsRateExpression
              - !Sub "rate(${UpdaterScheduleRate})"
              - !Ref UpdaterScheduleRate
            Enabled: true

  # Persist the DownloaderFunction ARN to SSM for Airflow to consume
  DownloaderFunctionArnParameter:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/${AWS::StackName}/downloader-function-arn"
      Type: String
      Value: !GetAtt DownloaderFunction.Arn
      Description: ARN of the downloader Lambda function for MWAA

  #####################################################################################################################
  # SQS (Workflow queue + DLQ for Step Functions trigger)
  #####################################################################################################################

  WorkflowDeadLetterQueue:
    Type: AWS::SQS::Queue
    Properties:
      MessageRetentionPeriod: 1209600
      VisibilityTimeout: 331
      SqsManagedSseEnabled: true
      Tags:
        - Key: Environment
          Value: !Ref EnvironmentName

  WorkflowSqsQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: !Ref WorkflowQueueName
      VisibilityTimeout: 331
      MessageRetentionPeriod: 1209600
      SqsManagedSseEnabled: true
      RedrivePolicy:
        deadLetterTargetArn: !GetAtt WorkflowDeadLetterQueue.Arn
        maxReceiveCount: 1
      Tags:
        - Key: Environment
          Value: !Ref EnvironmentName

  TransactionsSqsQueue:
    Type: AWS::SQS::Queue
    Properties:
      VisibilityTimeout: 331
      MessageRetentionPeriod: 1209600
      SqsManagedSseEnabled: true
      RedrivePolicy:
        deadLetterTargetArn: !GetAtt TransactionsDeadLetterQueue.Arn
        maxReceiveCount: 3
      Tags:
        - Key: Environment
          Value: !Ref EnvironmentName

  TransactionsDeadLetterQueue:
    Type: AWS::SQS::Queue
    Properties:
      MessageRetentionPeriod: 1209600
      VisibilityTimeout: 331
      SqsManagedSseEnabled: true
      Tags:
        - Key: Environment
          Value: !Ref EnvironmentName

  #####################################################################################################################
  # SQS Queues for Granular Workflow Steps (Transform, SVL, Hash, Upload)
  #####################################################################################################################

  TransformDeadLetterQueue:
    Type: AWS::SQS::Queue
    Properties:
      MessageRetentionPeriod: 1209600
      VisibilityTimeout: 331
      SqsManagedSseEnabled: true
      Tags:
        - Key: Environment
          Value: !Ref EnvironmentName

  TransformQueue:
    Type: AWS::SQS::Queue
    Properties:
      VisibilityTimeout: 331
      MessageRetentionPeriod: 1209600
      SqsManagedSseEnabled: true
      RedrivePolicy:
        deadLetterTargetArn: !GetAtt TransformDeadLetterQueue.Arn
        maxReceiveCount: 1
      Tags:
        - Key: Environment
          Value: !Ref EnvironmentName

  SvlDeadLetterQueue:
    Type: AWS::SQS::Queue
    Properties:
      MessageRetentionPeriod: 1209600
      VisibilityTimeout: 331
      SqsManagedSseEnabled: true
      Tags:
        - Key: Environment
          Value: !Ref EnvironmentName

  SvlQueue:
    Type: AWS::SQS::Queue
    Properties:
      VisibilityTimeout: 331
      MessageRetentionPeriod: 1209600
      SqsManagedSseEnabled: true
      RedrivePolicy:
        deadLetterTargetArn: !GetAtt SvlDeadLetterQueue.Arn
        maxReceiveCount: 1
      Tags:
        - Key: Environment
          Value: !Ref EnvironmentName

  HashDeadLetterQueue:
    Type: AWS::SQS::Queue
    Properties:
      MessageRetentionPeriod: 1209600
      VisibilityTimeout: 331
      SqsManagedSseEnabled: true
      Tags:
        - Key: Environment
          Value: !Ref EnvironmentName

  HashQueue:
    Type: AWS::SQS::Queue
    Properties:
      VisibilityTimeout: 331
      MessageRetentionPeriod: 1209600
      SqsManagedSseEnabled: true
      RedrivePolicy:
        deadLetterTargetArn: !GetAtt HashDeadLetterQueue.Arn
        maxReceiveCount: 1
      Tags:
        - Key: Environment
          Value: !Ref EnvironmentName

  UploadDeadLetterQueue:
    Type: AWS::SQS::Queue
    Properties:
      MessageRetentionPeriod: 1209600
      VisibilityTimeout: 331
      SqsManagedSseEnabled: true
      Tags:
        - Key: Environment
          Value: !Ref EnvironmentName

  UploadQueue:
    Type: AWS::SQS::Queue
    Properties:
      VisibilityTimeout: 331
      MessageRetentionPeriod: 1209600
      SqsManagedSseEnabled: true
      RedrivePolicy:
        deadLetterTargetArn: !GetAtt UploadDeadLetterQueue.Arn
        maxReceiveCount: 1
      Tags:
        - Key: Environment
          Value: !Ref EnvironmentName

  #####################################################################################################################
  # DynamoDB Table for Proxy Rotation
  #####################################################################################################################

  ProxyRotationTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub "${AWS::StackName}-ProxyRotation"
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: proxyId
          AttributeType: S
        - AttributeName: constantKey
          AttributeType: S
        - AttributeName: lastUsedTime
          AttributeType: N
      KeySchema:
        - AttributeName: proxyId
          KeyType: HASH
      GlobalSecondaryIndexes:
        - IndexName: LastUsedIndex
          KeySchema:
            - AttributeName: constantKey
              KeyType: HASH
            - AttributeName: lastUsedTime
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
      Tags:
        - Key: Environment
          Value: !Ref EnvironmentName

  #####################################################################################################################
  # DynamoDB Table with PK and SK
  #####################################################################################################################

  ErrorsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: PK
          AttributeType: S
        - AttributeName: SK
          AttributeType: S
        - AttributeName: GS1PK
          AttributeType: S
        - AttributeName: GS1SK
          AttributeType: S
        - AttributeName: GS2PK
          AttributeType: S
        - AttributeName: GS2SK
          AttributeType: S
        - AttributeName: GS3PK
          AttributeType: S
        - AttributeName: GS3SK
          AttributeType: S
      KeySchema:
        - AttributeName: PK
          KeyType: HASH
        - AttributeName: SK
          KeyType: RANGE
      GlobalSecondaryIndexes:
        - IndexName: ErrorHashExecutionIndex
          KeySchema:
            - AttributeName: GS1PK
              KeyType: HASH
            - AttributeName: GS1SK
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
        - IndexName: ExecutionStatusIndex
          KeySchema:
            - AttributeName: GS2PK
              KeyType: HASH
            - AttributeName: GS2SK
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
        - IndexName: ExecutionErrorCountIndex
          KeySchema:
            - AttributeName: GS3PK
              KeyType: HASH
            - AttributeName: GS3SK
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
      StreamSpecification:
        StreamViewType: NEW_AND_OLD_IMAGES
      Tags:
        - Key: Environment
          Value: !Ref EnvironmentName

  #####################################################################################################################
  # Workflow Lambdas (starter -> pre -> prepare -> post)
  #####################################################################################################################

  SubmitterFunction:
    Type: AWS::Serverless::Function
    Properties:
      Runtime: nodejs22.x
      Architectures:
        - arm64
      MemorySize: 256
      Timeout: 300
      EphemeralStorage:
        Size: 1024
      CodeUri: ../workflow/lambdas/submit/
      Handler: index.handler
      Description: "Submits data to the blockchain"
      LoggingConfig:
        LogFormat: JSON
      Policies:
        - AWSLambdaBasicExecutionRole
        - Version: "2012-10-17"
          Statement:
            - Effect: Allow
              Action:
                - s3:GetObject
              Resource: !Sub "${EnvironmentBucket.Arn}/keystores/*"
      Environment:
        Variables:
          ELEPHANT_DOMAIN: !Ref ElephantDomain
          ELEPHANT_API_KEY: !Ref ElephantApiKey
          ELEPHANT_ORACLE_KEY_ID: !Ref ElephantOracleKeyId
          ELEPHANT_FROM_ADDRESS: !Ref ElephantFromAddress
          ELEPHANT_RPC_URL: !Ref ElephantRpcUrl
          ELEPHANT_KEYSTORE_S3_KEY: !Ref ElephantKeystoreS3Key
          ELEPHANT_KEYSTORE_PASSWORD: !Ref ElephantKeystorePassword
          ENVIRONMENT_BUCKET: !Ref EnvironmentBucket
      Events:
        Submit:
          Type: SQS
          Properties:
            Queue: !GetAtt TransactionsSqsQueue.Arn
            BatchSize: 150
            MaximumBatchingWindowInSeconds: 300
            ScalingConfig:
              MaximumConcurrency: 2

  WorkflowStarterFunction:
    Type: AWS::Serverless::Function
    Properties:
      Runtime: nodejs22.x
      Architectures:
        - arm64
      MemorySize: 128
      Timeout: 900
      CodeUri: ../workflow/lambdas/starter
      Handler: index.handler
      Description: "SQS-triggered starter that starts Standard state machine and waits for full completion with concurrency control"
      LoggingConfig:
        LogFormat: JSON
      Policies:
        - AWSLambdaBasicExecutionRole
        - arn:aws:iam::aws:policy/AmazonS3FullAccess
        - Version: "2012-10-17"
          Statement:
            - Effect: Allow
              Action:
                - states:StartExecution
                - states:ListExecutions
                - states:DescribeExecution
              Resource: !GetAtt ElephantExpressStateMachine.Arn
            - Effect: Allow
              Action:
                - states:DescribeExecution
              Resource: !Sub "arn:aws:states:${AWS::Region}:${AWS::AccountId}:execution:*"
      Environment:
        Variables:
          STATE_MACHINE_ARN: !GetAtt ElephantExpressStateMachine.Arn
          MAX_CONCURRENT_EXECUTIONS: !Ref WorkflowStarterReservedConcurrency
          MAX_RUNNING_EXECUTIONS: !Ref MaxRunningExecutions
      Events:
        SqsEvent:
          Type: SQS
          Properties:
            Queue: !GetAtt WorkflowSqsQueue.Arn
            BatchSize: 1
            MaximumBatchingWindowInSeconds: 0
            ScalingConfig:
              MaximumConcurrency: !Ref WorkflowStarterReservedConcurrency
      ReservedConcurrentExecutions: !Ref WorkflowStarterReservedConcurrency

  WorkflowPreProcessorFunction:
    Type: AWS::Serverless::Function
    Properties:
      Runtime: nodejs22.x
      Architectures:
        - arm64
      MemorySize: 512
      Timeout: 300
      EphemeralStorage:
        Size: 1024
      CodeUri: ../workflow/lambdas/pre
      Handler: index.handler
      Description: "Prepares seed output and input.zip for prepare step"
      LoggingConfig:
        LogFormat: JSON
      Policies:
        - AWSLambdaBasicExecutionRole
        - arn:aws:iam::aws:policy/AmazonS3FullAccess
        - S3CrudPolicy:
            BucketName: !Ref EnvironmentBucket
      Environment:
        Variables:
          OUTPUT_BASE_URI: !Sub "s3://${EnvironmentBucket}/outputs"

  WorkflowMirrorValidatorFunction:
    Type: AWS::Serverless::Function
    Properties:
      PackageType: Image
      MemorySize: 2048
      Timeout: 300
      EphemeralStorage:
        Size: 3072
      Description: "Performs mirror validation to measure data completeness"
      LoggingConfig:
        LogFormat: JSON
      Policies:
        - AWSLambdaBasicExecutionRole
        - S3CrudPolicy:
            BucketName: !Ref EnvironmentBucket
        - arn:aws:iam::aws:policy/AmazonS3FullAccess
        - DynamoDBCrudPolicy:
            TableName: !Ref ErrorsTable
      Environment:
        Variables:
          OUTPUT_BASE_URI: !Sub "s3://${EnvironmentBucket}/outputs"
          ERRORS_TABLE_NAME: !Ref ErrorsTable
    Metadata:
      DockerTag: latest
      DockerContext: ../workflow/lambdas/mvl
      Dockerfile: Dockerfile

  #####################################################################################################################
  # Granular Workflow Worker Lambdas (Transform, SVL, Hash, Upload)
  #####################################################################################################################

  TransformWorkerFunction:
    Type: AWS::Serverless::Function
    Properties:
      Runtime: nodejs22.x
      Architectures:
        - arm64
      MemorySize: 512
      Timeout: 300
      EphemeralStorage:
        Size: 2048
      CodeUri: ../workflow/lambdas/transform-worker
      Handler: index.handler
      Description: "Performs county data transformation"
      LoggingConfig:
        LogFormat: JSON
      Policies:
        - AWSLambdaBasicExecutionRole
        - arn:aws:iam::aws:policy/AmazonS3FullAccess
        - Version: "2012-10-17"
          Statement:
            - Effect: Allow
              Action:
                - states:SendTaskSuccess
                - states:SendTaskFailure
              Resource: "*"
            - Effect: Allow
              Action:
                - events:PutEvents
              Resource: "*"
      Environment:
        Variables:
          TRANSFORM_S3_PREFIX: !Ref TransformS3Prefix
      Events:
        SqsEvent:
          Type: SQS
          Properties:
            Queue: !GetAtt TransformQueue.Arn
            BatchSize: 1
            ScalingConfig:
              MaximumConcurrency: 10

  SvlWorkerFunction:
    Type: AWS::Serverless::Function
    Properties:
      Runtime: nodejs22.x
      Architectures:
        - arm64
      MemorySize: 512
      Timeout: 300
      EphemeralStorage:
        Size: 2048
      CodeUri: ../workflow/lambdas/svl-worker
      Handler: index.handler
      Description: "Performs schema validation layer checks"
      LoggingConfig:
        LogFormat: JSON
      Policies:
        - AWSLambdaBasicExecutionRole
        - arn:aws:iam::aws:policy/AmazonS3FullAccess
        - DynamoDBCrudPolicy:
            TableName: !Ref ErrorsTable
        - Version: "2012-10-17"
          Statement:
            - Effect: Allow
              Action:
                - states:SendTaskSuccess
                - states:SendTaskFailure
              Resource: "*"
            - Effect: Allow
              Action:
                - events:PutEvents
              Resource: "*"
      Environment:
        Variables:
          ERRORS_TABLE_NAME: !Ref ErrorsTable
      Events:
        SqsEvent:
          Type: SQS
          Properties:
            Queue: !GetAtt SvlQueue.Arn
            BatchSize: 1
            ScalingConfig:
              MaximumConcurrency: 10

  HashWorkerFunction:
    Type: AWS::Serverless::Function
    Properties:
      Runtime: nodejs22.x
      Architectures:
        - arm64
      MemorySize: 512
      Timeout: 300
      EphemeralStorage:
        Size: 2048
      CodeUri: ../workflow/lambdas/hash-worker
      Handler: index.handler
      Description: "Generates hash outputs for seed and county data"
      LoggingConfig:
        LogFormat: JSON
      Policies:
        - AWSLambdaBasicExecutionRole
        - arn:aws:iam::aws:policy/AmazonS3FullAccess
        - Version: "2012-10-17"
          Statement:
            - Effect: Allow
              Action:
                - states:SendTaskSuccess
                - states:SendTaskFailure
              Resource: "*"
            - Effect: Allow
              Action:
                - events:PutEvents
              Resource: "*"
      Events:
        SqsEvent:
          Type: SQS
          Properties:
            Queue: !GetAtt HashQueue.Arn
            BatchSize: 1
            ScalingConfig:
              MaximumConcurrency: 10

  UploadWorkerFunction:
    Type: AWS::Serverless::Function
    Properties:
      Runtime: nodejs22.x
      Architectures:
        - arm64
      MemorySize: 512
      Timeout: 300
      EphemeralStorage:
        Size: 2048
      CodeUri: ../workflow/lambdas/upload-worker
      Handler: index.handler
      Description: "Uploads hash archives to IPFS via Pinata"
      LoggingConfig:
        LogFormat: JSON
      Policies:
        - AWSLambdaBasicExecutionRole
        - arn:aws:iam::aws:policy/AmazonS3FullAccess
        - Version: "2012-10-17"
          Statement:
            - Effect: Allow
              Action:
                - states:SendTaskSuccess
                - states:SendTaskFailure
              Resource: "*"
            - Effect: Allow
              Action:
                - events:PutEvents
              Resource: "*"
      Environment:
        Variables:
          ELEPHANT_PINATA_JWT: !Ref ElephantPinataJwt
      Events:
        SqsEvent:
          Type: SQS
          Properties:
            Queue: !GetAtt UploadQueue.Arn
            BatchSize: 1
            ScalingConfig:
              MaximumConcurrency: 5

  ErrorResolverFunction:
    Type: AWS::Serverless::Function
    Properties:
      Runtime: nodejs22.x
      Architectures:
        - arm64
      MemorySize: 256
      Timeout: 330
      CodeUri: ../workflow/lambdas/error-resolver
      Handler: index.handler
      Description: "Processes DynamoDB stream events to resolve execution errors and restart executions"
      LoggingConfig:
        LogFormat: JSON
      Policies:
        - AWSLambdaBasicExecutionRole
        - DynamoDBCrudPolicy:
            TableName: !Ref ErrorsTable
        - Version: "2012-10-17"
          Statement:
            - Effect: Allow
              Action:
                - lambda:InvokeFunction
              Resource:
                - !GetAtt TransformWorkerFunction.Arn
                - !GetAtt SvlWorkerFunction.Arn
            - Effect: Allow
              Action:
                - sqs:SendMessage
                - sqs:GetQueueUrl
              Resource:
                - !Sub "arn:${AWS::Partition}:sqs:${AWS::Region}:${AWS::AccountId}:*"
            - Effect: Allow
              Action:
                - cloudwatch:PutMetricData
              Resource: "*"
              Condition:
                StringEquals:
                  cloudwatch:namespace:
                    - AutoRepair
                    - ExecutionRestart
      Environment:
        Variables:
          ERRORS_TABLE_NAME: !Ref ErrorsTable
          TRANSFORM_WORKER_FUNCTION_NAME: !Ref TransformWorkerFunction
          SVL_WORKER_FUNCTION_NAME: !Ref SvlWorkerFunction
          OUTPUT_S3_PREFIX: !Sub "s3://${EnvironmentBucket}/outputs"
      Events:
        ErrorsTableStream:
          Type: DynamoDB
          Properties:
            Stream: !GetAtt ErrorsTable.StreamArn
            StartingPosition: LATEST
            FilterCriteria:
              Filters:
                - Pattern: '{ "dynamodb": { "NewImage": { "entityType": { "S": [ "ExecutionError" ] }, "status": { "S": [ "maybeSolved" ] } }, "OldImage": { "status": { "S": [ "failed" ] } } } }'
            MaximumBatchingWindowInSeconds: 5
            BatchSize: 100

  #####################################################################################################################
  # GitHub Sync Lambda Function
  #####################################################################################################################

  GitHubSyncFunction:
    Type: AWS::Serverless::Function
    Properties:
      Runtime: nodejs22.x
      Architectures:
        - arm64
      MemorySize: 512
      Timeout: 300
      EphemeralStorage:
        Size: 1024
      CodeUri: lambdas/github-sync
      Handler: index.handler
      Description: "Syncs transform scripts from S3 to GitHub repository and creates PRs"
      LoggingConfig:
        LogFormat: JSON
      Policies:
        - AWSLambdaBasicExecutionRole
        - arn:aws:iam::aws:policy/AmazonS3FullAccess
        - Version: "2012-10-17"
          Statement:
            - Effect: Allow
              Action:
                - secretsmanager:GetSecretValue
              Resource:
                Ref: GitHubTokenSecret
      Environment:
        Variables:
          GITHUB_SECRET_NAME: !Ref GitHubTokenSecret
          UPSTREAM_REPO: elephant-xyz/Counties-trasform-scripts
      Events:
        S3TransformUpload:
          Type: S3
          Properties:
            Bucket: !Ref EnvironmentBucket
            Events: s3:ObjectCreated:*
            Filter:
              S3Key:
                Rules:
                  - Name: prefix
                    Value: transforms/
                  - Name: suffix
                    Value: .zip

  #####################################################################################################################
  # Standard Step Functions State Machine (separate definition file)
  #####################################################################################################################

  ElephantExpressStateMachine:
    Type: AWS::Serverless::StateMachine
    Properties:
      # Name property commented out to allow CloudFormation replacement when changing Type
      # For fresh deployments: Uncomment the line below and set WorkflowStateMachineName parameter
      # For updates: Leave commented to allow auto-generated name (enables replacement)
      # Name: !Ref WorkflowStateMachineName
      Type: STANDARD
      DefinitionUri: ../workflow/state-machines/elephant-express.asl.yaml
      DefinitionSubstitutions:
        WorkflowPreProcessorFunction: !GetAtt WorkflowPreProcessorFunction.Arn
        DownloaderFunction: !GetAtt DownloaderFunction.Arn
        WorkflowMirrorValidatorFunction: !GetAtt WorkflowMirrorValidatorFunction.Arn
        TransactionsSqsQueueUrl: !Ref TransactionsSqsQueue
        TransformQueueUrl: !Ref TransformQueue
        SvlQueueUrl: !Ref SvlQueue
        HashQueueUrl: !Ref HashQueue
        UploadQueueUrl: !Ref UploadQueue
        StackName: !Ref AWS::StackName
      Role: !GetAtt ElephantExpressStateMachineRole.Arn
      Logging:
        Destinations:
          - CloudWatchLogsLogGroup:
              LogGroupArn: !GetAtt ElephantExpressLogGroup.Arn
        IncludeExecutionData: true
        Level: ALL
      Tracing:
        Enabled: true

  ElephantExpressLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      # Log group name will be auto-generated by Step Functions when Name is not set
      # Or use: !Sub "/aws/vendedlogs/states/${ElephantExpressStateMachine.Name}"
      LogGroupName: !Sub "/aws/vendedlogs/states/${AWS::StackName}-ElephantExpressStateMachine"
      RetentionInDays: 14

  ElephantExpressStateMachineRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service: states.amazonaws.com
            Action: sts:AssumeRole
      Path: "/service-role/"
      Policies:
        - PolicyName: ElephantExpressInline
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Effect: Allow
                Action:
                  - lambda:InvokeFunction
                Resource:
                  - !GetAtt WorkflowPreProcessorFunction.Arn
                  - !GetAtt DownloaderFunction.Arn
                  - !GetAtt WorkflowMirrorValidatorFunction.Arn
              - Effect: Allow
                Action:
                  - sqs:SendMessage
                Resource:
                  - !GetAtt TransactionsSqsQueue.Arn
                  - !GetAtt TransformQueue.Arn
                  - !GetAtt SvlQueue.Arn
                  - !GetAtt HashQueue.Arn
                  - !GetAtt UploadQueue.Arn
              - Effect: Allow
                Action:
                  - ssm:GetParameter
                Resource:
                  - !Sub "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/${AWS::StackName}/repair/*"
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:HeadObject
                Resource:
                  - !Sub "${EnvironmentBucket.Arn}/*"
              - Effect: Allow
                Action:
                  - cloudwatch:PutMetricData
                Resource: "*"
                Condition:
                  StringEquals:
                    cloudwatch:namespace:
                      - ElephantWorkflow
              - Effect: Allow
                Action:
                  - events:PutEvents
                Resource: "*"
              - Effect: Allow
                Action:
                  - logs:CreateLogDelivery
                  - logs:GetLogDelivery
                  - logs:UpdateLogDelivery
                  - logs:DeleteLogDelivery
                  - logs:ListLogDeliveries
                  - logs:PutResourcePolicy
                  - logs:DescribeResourcePolicies
                  - logs:DescribeLogGroups
                Resource: "*"

  #####################################################################################################################
  # CloudWatch Dashboard for Error Recovery Metrics
  #####################################################################################################################

  ErrorRecoveryDashboard:
    Type: AWS::CloudWatch::Dashboard
    Properties:
      DashboardName: !Sub "${AWS::StackName}-ErrorRecovery"
      DashboardBody: !Sub
        - |
          {
            "widgets": [
              {
                "type": "metric",
                "x": 0,
                "y": 0,
                "width": 24,
                "height": 6,
                "properties": {
                  "metrics": [
                    [{"expression": "SEARCH('{AutoRepair,County} MetricName=\"AutoRepairWorkflowSuccess\"', 'Sum', 300)", "label": "Success", "color": "#2ca02c", "id": "e1"}],
                    [{"expression": "SEARCH('{AutoRepair} MetricName=\"AutoRepairWorkflowFailure\" ErrorType=\"SVL\"', 'Sum', 300)", "label": "Failure", "color": "#d62728", "id": "e2"}]
                  ],
                  "period": 300,
                  "stat": "Sum",
                  "region": "${Region}",
                  "title": "AutoRepair Success/Failure",
                  "view": "timeSeries",
                  "stacked": false,
                  "yAxis": {
                    "left": {
                      "min": 0,
                      "label": "Count"
                    }
                  }
                }
              },
              {
                "type": "metric",
                "x": 0,
                "y": 6,
                "width": 24,
                "height": 6,
                "properties": {
                  "metrics": [
                    [{"expression": "SEARCH('{ExecutionRestart,County} MetricName=\"ExecutionRestartSuccess\"', 'Sum', 300)", "label": "Success", "color": "#2ca02c", "id": "e3"}],
                    [{"expression": "SEARCH('{ExecutionRestart,County} MetricName=\"ExecutionRestartFailure\"', 'Sum', 300)", "label": "Failure", "color": "#d62728", "id": "e4"}]
                  ],
                  "period": 300,
                  "stat": "Sum",
                  "region": "${Region}",
                  "title": "AutoErrorResolver",
                  "view": "timeSeries",
                  "stacked": false,
                  "yAxis": {
                    "left": {
                      "min": 0,
                      "label": "Count"
                    }
                  }
                }
              },
              {
                "type": "metric",
                "x": 0,
                "y": 12,
                "width": 24,
                "height": 6,
                "properties": {
                  "metrics": [
                    ["ElephantWorkflow", "WorkflowExecution", "Status", "Started", {"stat": "Sum", "label": "Started", "color": "#1f77b4"}],
                    ["ElephantWorkflow", "WorkflowExecution", "Status", "Success", {"stat": "Sum", "label": "Success", "color": "#2ca02c"}],
                    ["ElephantWorkflow", "WorkflowExecution", "Status", "Failure", {"stat": "Sum", "label": "Failure", "color": "#d62728"}]
                  ],
                  "period": 300,
                  "stat": "Sum",
                  "region": "${Region}",
                  "title": "Workflow Execution Success/Failure",
                  "view": "timeSeries",
                  "stacked": false,
                  "yAxis": {
                    "left": {
                      "min": 0,
                      "label": "Count"
                    }
                  }
                }
              },
              {
                "type": "metric",
                "x": 0,
                "y": 18,
                "width": 24,
                "height": 6,
                "properties": {
                  "metrics": [
                    ["AWS/States", "ExecutionsStarted", "StateMachineArn", "${StateMachineArn}", {"stat": "Sum", "label": "Executions Started", "color": "#1f77b4"}],
                    ["AWS/States", "ExecutionsSucceeded", "StateMachineArn", "${StateMachineArn}", {"stat": "Sum", "label": "Executions Succeeded", "color": "#2ca02c"}],
                    ["AWS/States", "ExecutionsFailed", "StateMachineArn", "${StateMachineArn}", {"stat": "Sum", "label": "Executions Failed", "color": "#d62728"}]
                  ],
                  "period": 300,
                  "stat": "Sum",
                  "region": "${Region}",
                  "title": "Execution",
                  "view": "timeSeries",
                  "stacked": false,
                  "yAxis": {
                    "left": {
                      "min": 0,
                      "label": "Count"
                    }
                  }
                }
              },
              {
                "type": "metric",
                "x": 0,
                "y": 24,
                "width": 24,
                "height": 6,
                "properties": {
                  "metrics": [
                    ["AWS/DynamoDB", "ConsumedWriteCapacityUnits", "TableName", "${ErrorsTableName}", {"stat": "Sum", "label": "Write Capacity Consumed"}]
                  ],
                  "period": 300,
                  "stat": "Sum",
                  "region": "${Region}",
                  "title": "Validation Error DynamoDB Write",
                  "view": "timeSeries",
                  "yAxis": {
                    "left": {
                      "min": 0,
                      "label": "Capacity Units"
                    }
                  }
                }
              }
            ]
          }
        - Region: !Ref AWS::Region
          StateMachineArn: !Ref ElephantExpressStateMachine
          ErrorsTableName: !Ref ErrorsTable

  #####################################################################################################################
  # Step Function for S3 to SQS processing
  #####################################################################################################################

  StepFunctionRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service: states.amazonaws.com
            Action: sts:AssumeRole
      Path: "/service-role/"
      Policies:
        - PolicyName: StepFunctionS3SqsPolicy
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Effect: Allow
                Action:
                  - s3:ListBucket
                  - s3:GetObject
                Resource:
                  - !GetAtt EnvironmentBucket.Arn
                  - !Sub "${EnvironmentBucket.Arn}/*"
              - Effect: Allow
                Action:
                  - s3:ListBucket
                Resource: "*"
              - Effect: Allow
                Action:
                  - sqs:SendMessage
                  - sqs:GetQueueUrl
                Resource:
                  - !GetAtt MwaaSqsQueue.Arn
                  - !GetAtt WorkflowSqsQueue.Arn
                  # Allow sending to county-specific queues (elephant-workflow-queue-*)
                  - !Sub "arn:aws:sqs:${AWS::Region}:${AWS::AccountId}:elephant-workflow-queue-*"
              - Effect: Allow
                Action:
                  - states:StartExecution
                Resource:
                  - !Sub "arn:aws:states:${AWS::Region}:${AWS::AccountId}:stateMachine:${AWS::StackName}-*"
              # Required for states:startExecution.sync to create the managed EventBridge rule
              - Effect: Allow
                Action:
                  - events:PutRule
                  - events:PutTargets
                  - events:DescribeRule
                  - events:DeleteRule
                  - events:RemoveTargets
                Resource:
                  - !Sub "arn:aws:events:${AWS::Region}:${AWS::AccountId}:rule/StepFunctionsGetEventsForStepFunctionsExecutionRule"

  # Child state machine: processes a single page starting after a given key and maps to SQS
  S3PageProcessorStateMachine:
    Type: AWS::StepFunctions::StateMachine
    Properties:
      StateMachineName: !Sub "${AWS::StackName}-S3PageProcessor"
      RoleArn: !GetAtt StepFunctionRole.Arn
      DefinitionString: |
        {
          "Comment": "Process one S3 page (MaxKeys=1000) starting after StartAfter and send SQS messages",
          "StartAt": "BranchList",
          "States": {
            "BranchList": {
              "Type": "Choice",
              "Choices": [
                { "Variable": "$.continuationToken", "IsPresent": true, "Next": "ListPageWithToken" },
                { "Variable": "$.startAfter", "IsPresent": true, "Next": "ListPageWithStartAfter" }
              ],
              "Default": "ListPageNoStartAfter"
            },
             "ListPageWithToken": {
               "Type": "Task",
               "Resource": "arn:aws:states:::aws-sdk:s3:listObjectsV2",
               "Parameters": {
                 "Bucket.$": "$.bucketName",
                 "MaxKeys": 1000,
                 "ContinuationToken.$": "$.continuationToken"
               },
               "ResultPath": "$.list",
               "Next": "FilterCsvFiles",
               "Retry": [
                 { "ErrorEquals": ["States.TaskFailed", "S3.NoSuchBucket", "S3.AccessDenied"], "IntervalSeconds": 2, "MaxAttempts": 3, "BackoffRate": 2.0 }
               ],
               "Catch": [
                 { "ErrorEquals": ["States.ALL"], "ResultPath": "$.errorInfo", "Next": "ReturnEmpty" }
               ]
             },
             "ListPageNoStartAfter": {
               "Type": "Task",
               "Resource": "arn:aws:states:::aws-sdk:s3:listObjectsV2",
               "Parameters": {
                 "Bucket.$": "$.bucketName",
                 "MaxKeys": 1000
               },
               "ResultPath": "$.list",
               "Next": "FilterCsvFiles",
               "Retry": [

                 {
                   "ErrorEquals": ["States.TaskFailed", "S3.NoSuchBucket", "S3.AccessDenied"],
                   "IntervalSeconds": 2,
                   "MaxAttempts": 3,
                   "BackoffRate": 2.0
                 }
               ],
               "Catch": [
                 {
                   "ErrorEquals": ["States.ALL"],
                   "ResultPath": "$.errorInfo",
                   "Next": "ReturnEmpty"
                 }
               ]
              },
             "ListPageWithStartAfter": {
               "Type": "Task",
               "Resource": "arn:aws:states:::aws-sdk:s3:listObjectsV2",
               "Parameters": {
                 "Bucket.$": "$.bucketName",
                 "MaxKeys": 1000,
                 "StartAfter.$": "$.startAfter"
               },
               "ResultPath": "$.list",
               "Next": "FilterCsvFiles",
               "Retry": [
                 { "ErrorEquals": ["States.TaskFailed", "S3.NoSuchBucket", "S3.AccessDenied"], "IntervalSeconds": 2, "MaxAttempts": 3, "BackoffRate": 2.0 }
               ],
               "Catch": [
                 { "ErrorEquals": ["States.ALL"], "ResultPath": "$.errorInfo", "Next": "ReturnEmpty" }
               ]
             },
             "FilterCsvFiles": {
               "Type": "Pass",
               "QueryLanguage": "JSONata",
               "Output": "{% { 'bucketName': $states.input.bucketName, 'continuationToken': $states.input.continuationToken, 'startAfter': $states.input.startAfter, 'sqsQueueUrl': $states.input.sqsQueueUrl, 'list': { 'Contents': $states.input.list.Contents[ $substring(Key, $length(Key) - 4) = '.csv' ], 'IsTruncated': $states.input.list.IsTruncated, 'NextContinuationToken': $states.input.list.NextContinuationToken } } %}",
               "Next": "ProcessOrDone"
             },
             "ProcessOrDone": {
               "Type": "Choice",
               "Choices": [
                 {
                   "Variable": "$.list.Contents",
                   "IsPresent": true,
                   "Next": "MapObjects"
                 }
               ],
               "Default": "ReturnEmpty"
             },
            "MapObjects": {
              "Type": "Map",
              "MaxConcurrency": 0,
              "ItemsPath": "$.list.Contents",
              "Iterator": {
                "StartAt": "CreateMessage",
                "States": {
                  "CreateMessage": {
                    "Type": "Pass",
                    "Parameters": {
                      "s3": {
                        "bucket": { "name.$": "$$.Execution.Input.bucketName" },
                        "object": { "key.$": "$.Key" }
                      }
                    },
                    "ResultPath": "$.message",
                    "Next": "SendToSQS"
                  },
                  "SendToSQS": {
                    "Type": "Task",
                    "Resource": "arn:aws:states:::sqs:sendMessage",
                    "Parameters": {
                      "QueueUrl.$": "$$.Execution.Input.sqsQueueUrl",
                      "MessageBody.$": "States.JsonToString($.message)"
                    },
                    "ResultPath": "$.sqsResult",
                    "Next": "Success",
                    "Retry": [
                      {
                        "ErrorEquals": ["States.TaskFailed", "SQS.QueueDoesNotExist", "SQS.InvalidMessageContents"],
                        "IntervalSeconds": 1,
                        "MaxAttempts": 3,
                        "BackoffRate": 2.0
                      },
                      { "ErrorEquals": ["States.Timeout"], "IntervalSeconds": 3, "MaxAttempts": 2, "BackoffRate": 1.5 }
                    ],
                    "Catch": [
                      { "ErrorEquals": ["States.ALL"], "ResultPath": "$.errorInfo", "Next": "LogError" }
                    ]
                  },
                  "LogError": { "Type": "Pass", "Result": { "status": "error" }, "End": true },
                  "Success": { "Type": "Pass", "Result": { "status": "processed" }, "End": true }
                }
              },
              "ResultPath": "$.processed",
              "Next": "ReturnResult",
              "Catch": [
                { "ErrorEquals": ["States.TaskFailed", "States.MapRunFailed"], "ResultPath": "$.mapError", "Next": "ReturnResult" }
              ]
            },
            "ReturnEmpty": {
              "Type": "Pass",
              "Result": { "nextToken": null, "count": 0, "isTruncated": false },
              "End": true
            },
            "ReturnResult": {
              "Type": "Choice",
              "Choices": [
                {
                  "Variable": "$.list.NextContinuationToken",
                  "IsPresent": true,
                  "Next": "ReturnWithToken"
                }
              ],
              "Default": "ReturnWithoutToken"
            },
            "ReturnWithToken": {
              "Type": "Pass",
              "Parameters": {
                "nextToken.$": "$.list.NextContinuationToken",
                "count.$": "States.ArrayLength($.list.Contents)",
                "isTruncated.$": "$.list.IsTruncated"
              },
              "End": true
            },
            "ReturnWithoutToken": {
              "Type": "Pass",
              "Parameters": {
                "nextToken": null,
                "count.$": "States.ArrayLength($.list.Contents)",
                "isTruncated.$": "$.list.IsTruncated"
              },
              "End": true
            }
          }
        }

  # Parent/orchestrator state machine: loops child calls and recurses near history limit
  S3ToSqsStateMachine:
    Type: AWS::StepFunctions::StateMachine
    Properties:
      StateMachineName: !Sub "${AWS::StackName}-S3ToSqsProcessor"
      RoleArn: !GetAtt StepFunctionRole.Arn
      DefinitionSubstitutions:
        S3PageProcessorStateMachine: !Ref S3PageProcessorStateMachine
      DefinitionString: |
        {
          "Comment": "Orchestrate S3 pagination by invoking child per page; recurse at ~24.5k iterations",
          "StartAt": "InitBranch",
          "States": {
            "InitBranch": {
              "Type": "Choice",
              "Choices": [
                { "Variable": "$.continuationToken", "IsPresent": true, "Next": "InitWithToken" }
              ],
              "Default": "InitNoToken"
            },
            "InitWithToken": {
              "Type": "Pass",
              "Parameters": {
                "bucketName.$": "$.bucketName",
                "sqsQueueUrl.$": "$.sqsQueueUrl",
                "continuationToken.$": "$.continuationToken",
                "loopCount": 0
              },
              "ResultPath": "$.ctx",
              "Next": "ProcessPage"
            },
            "InitNoToken": {
              "Type": "Pass",
              "Parameters": {
                "bucketName.$": "$.bucketName",
                "sqsQueueUrl.$": "$.sqsQueueUrl",
                "continuationToken": null,
                "loopCount": 0
              },
              "ResultPath": "$.ctx",
              "Next": "ProcessPage"
            },
            "ProcessPage": {
              "Type": "Task",
              "Resource": "arn:aws:states:::states:startExecution.sync",
              "Parameters": {
                "StateMachineArn": "${S3PageProcessorStateMachine}",
                "Input": {
                  "bucketName.$": "$.ctx.bucketName",
                  "sqsQueueUrl.$": "$.ctx.sqsQueueUrl",
                  "continuationToken.$": "$.ctx.continuationToken"
                }
              },
              "ResultSelector": {
                "parsed.$": "States.StringToJson($.Output)"
              },
              "ResultPath": "$.child",
              "Next": "UpdateForNext",
              "Retry": [
                { "ErrorEquals": ["States.TaskFailed"], "IntervalSeconds": 2, "MaxAttempts": 3, "BackoffRate": 2.0 }
              ],
              "Catch": [
                { "ErrorEquals": ["States.ALL"], "ResultPath": "$.errorInfo", "Next": "Done" }
              ]
            },
            "UpdateForNext": {
              "Type": "Pass",
              "Parameters": {
                "ctx": {
                  "bucketName.$": "$.ctx.bucketName",
                  "sqsQueueUrl.$": "$.ctx.sqsQueueUrl",
                  "continuationToken.$": "$.child.parsed.nextToken",
                  "loopCount.$": "States.MathAdd($.ctx.loopCount, 1)"
                },
                "hasMore.$": "$.child.parsed.isTruncated"
              },
              "ResultPath": "$.loop",
              "Next": "ContinueOrRecurse"
            },
            "ContinueOrRecurse": {
              "Type": "Choice",
              "Choices": [
                { "Variable": "$.loop.hasMore", "BooleanEquals": true, "Next": "CheckLimit" }
              ],
              "Default": "Done"
            },
            "CheckLimit": {
              "Type": "Choice",
              "Choices": [
                { "Variable": "$.loop.ctx.loopCount", "NumericLessThan": 25, "Next": "ProcessPageFromLoop" }
              ],
              "Default": "Recurse"
            },
            "ProcessPageFromLoop": {
              "Type": "Pass",
              "InputPath": "$.loop.ctx",
              "ResultPath": "$.ctx",
              "Next": "ProcessPage"
            },
            "Recurse": {
              "Type": "Task",
              "Resource": "arn:aws:states:::states:startExecution",
              "Parameters": {
                "StateMachineArn.$": "$$.StateMachine.Id",
                "Name.$": "States.UUID()",
                "Input": {
                  "bucketName.$": "$.loop.ctx.bucketName",
                  "sqsQueueUrl.$": "$.loop.ctx.sqsQueueUrl",
                  "continuationToken.$": "$.loop.ctx.continuationToken"
                }
              },
              "ResultPath": "$.restarted",
              "Next": "Done"
            },
            "Done": { "Type": "Pass", "End": true }
          }
        }

Outputs:
  DownloaderFunctionName:
    Description: Name of the downloader Lambda function
    Value: !Ref DownloaderFunction
  DownloaderFunctionArn:
    Description: ARN of the downloader Lambda function
    Value: !GetAtt DownloaderFunction.Arn
  UpdaterFunctionName:
    Description: Name of the updater Lambda function
    Value: !Ref UpdaterFunction
  UpdaterFunctionArn:
    Description: ARN of the updater Lambda function
    Value: !GetAtt UpdaterFunction.Arn
  EnvironmentBucketName:
    Description: S3 Bucket for MWAA Environment
    Value: !Ref EnvironmentBucket
  MwaaSqsQueueUrl:
    Description: URL of the MWAA SQS Queue
    Value: !Ref MwaaSqsQueue
  MwaaSqsQueueArn:
    Description: ARN of the MWAA SQS Queue
    Value: !GetAtt MwaaSqsQueue.Arn
  MwaaDeadLetterQueueUrl:
    Description: URL of the MWAA Dead Letter Queue
    Value: !Ref MwaaDeadLetterQueue
  MwaaDeadLetterQueueArn:
    Description: ARN of the MWAA Dead Letter Queue
    Value: !GetAtt MwaaDeadLetterQueue.Arn
  DownloaderFunctionArnParameterName:
    Description: SSM Parameter name containing DownloaderFunction ARN
    Value: !Ref DownloaderFunctionArnParameter
  S3ToSqsStateMachineArn:
    Description: ARN of the S3 to SQS processing Step Function
    Value: !Ref S3ToSqsStateMachine
  S3ToSqsStateMachineName:
    Description: Name of the S3 to SQS processing Step Function
    Value: !GetAtt S3ToSqsStateMachine.Name
  WorkflowQueueUrl:
    Description: URL of the workflow SQS queue (Step Functions trigger)
    Value: !Ref WorkflowSqsQueue
  WorkflowQueueArn:
    Description: ARN of the workflow SQS queue
    Value: !GetAtt WorkflowSqsQueue.Arn
  ElephantExpressStateMachineArn:
    Description: ARN of the Elephant Standard state machine
    Value: !Ref ElephantExpressStateMachine
  ElephantExpressStateMachineName:
    Description: Name of the Elephant Standard state machine
    Value: !GetAtt ElephantExpressStateMachine.Name
  WorkflowMirrorValidatorFunctionName:
    Description: Name of the Workflow Mirror Validator Lambda function
    Value: !Ref WorkflowMirrorValidatorFunction
  WorkflowMirrorValidatorFunctionArn:
    Description: ARN of the Workflow Mirror Validator Lambda function
    Value: !GetAtt WorkflowMirrorValidatorFunction.Arn
  WorkflowMirrorValidatorLogGroupName:
    Description: CloudWatch Log Group name for the mirror validator Lambda function
    Value: !Sub "/aws/lambda/${WorkflowMirrorValidatorFunction}"
  WorkflowDeadLetterQueueUrl:
    Description: URL of the Workflow Dead Letter Queue
    Value: !Ref WorkflowDeadLetterQueue
  WorkflowDeadLetterQueueArn:
    Description: ARN of the Workflow Dead Letter Queue
    Value: !GetAtt WorkflowDeadLetterQueue.Arn
  TransactionsSqsQueueUrl:
    Description: URL of the Transactions SQS Queue
    Value: !Ref TransactionsSqsQueue
  TransactionsSqsQueueArn:
    Description: ARN of the Transactions SQS Queue
    Value: !GetAtt TransactionsSqsQueue.Arn
  TransactionsDeadLetterQueueUrl:
    Description: URL of the Transactions Dead Letter Queue
    Value: !Ref TransactionsDeadLetterQueue
  TransactionsDeadLetterQueueArn:
    Description: ARN of the Transactions Dead Letter Queue
    Value: !GetAtt TransactionsDeadLetterQueue.Arn
  ProxyRotationTableName:
    Description: Name of the Proxy Rotation DynamoDB table
    Value: !Ref ProxyRotationTable
  ProxyRotationTableArn:
    Description: ARN of the Proxy Rotation DynamoDB table
    Value: !GetAtt ProxyRotationTable.Arn
  ErrorsTableName:
    Description: Name of the Errors DynamoDB table
    Value: !Ref ErrorsTable
  GitHubSyncFunctionName:
    Description: Name of the GitHub Sync Lambda function
    Value: !Ref GitHubSyncFunction
  GitHubSyncFunctionArn:
    Description: ARN of the GitHub Sync Lambda function
    Value: !GetAtt GitHubSyncFunction.Arn
  ErrorRecoveryDashboardUrl:
    Description: URL to the ErrorRecovery CloudWatch Dashboard
    Value: !Sub "https://${AWS::Region}.console.aws.amazon.com/cloudwatch/home?region=${AWS::Region}#dashboards:name=${AWS::StackName}-ErrorRecovery"

  # Granular Workflow Step Queues
  TransformQueueUrl:
    Description: URL of the Transform SQS Queue
    Value: !Ref TransformQueue
  TransformQueueArn:
    Description: ARN of the Transform SQS Queue
    Value: !GetAtt TransformQueue.Arn
  SvlQueueUrl:
    Description: URL of the SVL SQS Queue
    Value: !Ref SvlQueue
  SvlQueueArn:
    Description: ARN of the SVL SQS Queue
    Value: !GetAtt SvlQueue.Arn
  HashQueueUrl:
    Description: URL of the Hash SQS Queue
    Value: !Ref HashQueue
  HashQueueArn:
    Description: ARN of the Hash SQS Queue
    Value: !GetAtt HashQueue.Arn
  UploadQueueUrl:
    Description: URL of the Upload SQS Queue
    Value: !Ref UploadQueue
  UploadQueueArn:
    Description: ARN of the Upload SQS Queue
    Value: !GetAtt UploadQueue.Arn

  # Granular Workflow Worker Functions
  TransformWorkerFunctionName:
    Description: Name of the Transform Worker Lambda function
    Value: !Ref TransformWorkerFunction
  TransformWorkerFunctionArn:
    Description: ARN of the Transform Worker Lambda function
    Value: !GetAtt TransformWorkerFunction.Arn
  SvlWorkerFunctionName:
    Description: Name of the SVL Worker Lambda function
    Value: !Ref SvlWorkerFunction
  SvlWorkerFunctionArn:
    Description: ARN of the SVL Worker Lambda function
    Value: !GetAtt SvlWorkerFunction.Arn
  HashWorkerFunctionName:
    Description: Name of the Hash Worker Lambda function
    Value: !Ref HashWorkerFunction
  HashWorkerFunctionArn:
    Description: ARN of the Hash Worker Lambda function
    Value: !GetAtt HashWorkerFunction.Arn
  UploadWorkerFunctionName:
    Description: Name of the Upload Worker Lambda function
    Value: !Ref UploadWorkerFunction
  UploadWorkerFunctionArn:
    Description: ARN of the Upload Worker Lambda function
    Value: !GetAtt UploadWorkerFunction.Arn
