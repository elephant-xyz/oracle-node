AWSTemplateFormatVersion: "2010-09-09"
Transform: AWS::Serverless-2016-10-31
Description: Build Transaction Workflow - Separated processing pipeline with Transform, SVL, MVL, Hash, and Upload steps

Parameters:
  EnvironmentName:
    Description: An environment name that is prefixed to resource names
    Type: String
    Default: BuildTransactionWorkflow

  # S3 Configuration
  OutputBucket:
    Description: S3 bucket for workflow outputs
    Type: String

  TransformS3Prefix:
    Description: S3 URI prefix containing county transform archives
    Type: String

  # Pinata (IPFS) Configuration
  ElephantPinataJwt:
    Description: Pinata JWT for IPFS uploads
    Type: String
    NoEcho: true

  # Concurrency Controls
  TransformWorkerConcurrency:
    Description: Maximum concurrent Transform worker executions
    Type: Number
    Default: 10

  SvlWorkerConcurrency:
    Description: Maximum concurrent SVL worker executions
    Type: Number
    Default: 20

  MvlWorkerConcurrency:
    Description: Maximum concurrent MVL worker executions
    Type: Number
    Default: 5

  HashWorkerConcurrency:
    Description: Maximum concurrent Hash worker executions
    Type: Number
    Default: 20

  UploadWorkerConcurrency:
    Description: Maximum concurrent Upload worker executions
    Type: Number
    Default: 10

  # MVL Toggle
  MvlEnabledDefault:
    Description: Whether MVL is enabled by default for new executions
    Type: String
    Default: "false"
    AllowedValues:
      - "true"
      - "false"

  # Errors Table (can reference existing or create new)
  ErrorsTableName:
    Description: Name of the DynamoDB table for errors (leave empty to create new)
    Type: String
    Default: ""

Conditions:
  CreateErrorsTable: !Equals [!Ref ErrorsTableName, ""]

Globals:
  Function:
    Timeout: 900  # 15 minutes max for long-running operations
    Tracing: Active

Resources:
  #####################################################################################################################
  # SQS Queues for Worker Steps
  #####################################################################################################################

  # Transform Queue
  TransformDeadLetterQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: !Sub "${EnvironmentName}-transform-dlq"
      MessageRetentionPeriod: 1209600
      SqsManagedSseEnabled: true

  TransformQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: !Sub "${EnvironmentName}-transform-queue"
      VisibilityTimeout: 960  # Slightly longer than Lambda timeout
      MessageRetentionPeriod: 1209600
      SqsManagedSseEnabled: true
      RedrivePolicy:
        deadLetterTargetArn: !GetAtt TransformDeadLetterQueue.Arn
        maxReceiveCount: 3

  # SVL Queue
  SvlDeadLetterQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: !Sub "${EnvironmentName}-svl-dlq"
      MessageRetentionPeriod: 1209600
      SqsManagedSseEnabled: true

  SvlQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: !Sub "${EnvironmentName}-svl-queue"
      VisibilityTimeout: 960
      MessageRetentionPeriod: 1209600
      SqsManagedSseEnabled: true
      RedrivePolicy:
        deadLetterTargetArn: !GetAtt SvlDeadLetterQueue.Arn
        maxReceiveCount: 3

  # MVL Queue
  MvlDeadLetterQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: !Sub "${EnvironmentName}-mvl-dlq"
      MessageRetentionPeriod: 1209600
      SqsManagedSseEnabled: true

  MvlQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: !Sub "${EnvironmentName}-mvl-queue"
      VisibilityTimeout: 960
      MessageRetentionPeriod: 1209600
      SqsManagedSseEnabled: true
      RedrivePolicy:
        deadLetterTargetArn: !GetAtt MvlDeadLetterQueue.Arn
        maxReceiveCount: 3

  # Hash Queue
  HashDeadLetterQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: !Sub "${EnvironmentName}-hash-dlq"
      MessageRetentionPeriod: 1209600
      SqsManagedSseEnabled: true

  HashQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: !Sub "${EnvironmentName}-hash-queue"
      VisibilityTimeout: 960
      MessageRetentionPeriod: 1209600
      SqsManagedSseEnabled: true
      RedrivePolicy:
        deadLetterTargetArn: !GetAtt HashDeadLetterQueue.Arn
        maxReceiveCount: 3

  # Upload Queue
  UploadDeadLetterQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: !Sub "${EnvironmentName}-upload-dlq"
      MessageRetentionPeriod: 1209600
      SqsManagedSseEnabled: true

  UploadQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: !Sub "${EnvironmentName}-upload-queue"
      VisibilityTimeout: 960
      MessageRetentionPeriod: 1209600
      SqsManagedSseEnabled: true
      RedrivePolicy:
        deadLetterTargetArn: !GetAtt UploadDeadLetterQueue.Arn
        maxReceiveCount: 3

  #####################################################################################################################
  # EventBridge for Error Resolution (Simplified)
  #####################################################################################################################

  ErrorResolutionEventBus:
    Type: AWS::Events::EventBus
    Properties:
      Name: !Sub "${EnvironmentName}-error-resolution"

  #####################################################################################################################
  # DynamoDB Errors Table (Conditional)
  #####################################################################################################################

  WorkflowErrorsTable:
    Type: AWS::DynamoDB::Table
    Condition: CreateErrorsTable
    Properties:
      TableName: !Sub "${EnvironmentName}-Errors"
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: PK
          AttributeType: S
        - AttributeName: SK
          AttributeType: S
      KeySchema:
        - AttributeName: PK
          KeyType: HASH
        - AttributeName: SK
          KeyType: RANGE
      StreamSpecification:
        StreamViewType: NEW_AND_OLD_IMAGES
      Tags:
        - Key: Environment
          Value: !Ref EnvironmentName

  #####################################################################################################################
  # Worker Lambda Functions
  #####################################################################################################################

  # Transform Worker
  TransformWorkerFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "${EnvironmentName}-transform-worker"
      Runtime: nodejs22.x
      MemorySize: 1024
      EphemeralStorage:
        Size: 2048
      CodeUri: lambdas/transform-worker
      Handler: index.handler
      Description: "Transform step worker - processes transform scripts"
      LoggingConfig:
        LogFormat: JSON
      Environment:
        Variables:
          TRANSFORM_S3_PREFIX: !Ref TransformS3Prefix
          OUTPUT_BASE_URI: !Sub "s3://${OutputBucket}/outputs"
      Policies:
        - AWSLambdaBasicExecutionRole
        - arn:aws:iam::aws:policy/AmazonS3FullAccess
        - Version: "2012-10-17"
          Statement:
            - Effect: Allow
              Action:
                - states:SendTaskSuccess
                - states:SendTaskFailure
              Resource: "*"
      Events:
        SqsEvent:
          Type: SQS
          Properties:
            Queue: !GetAtt TransformQueue.Arn
            BatchSize: 1
            ScalingConfig:
              MaximumConcurrency: !Ref TransformWorkerConcurrency

  # SVL Worker
  SvlWorkerFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "${EnvironmentName}-svl-worker"
      Runtime: nodejs22.x
      MemorySize: 512
      EphemeralStorage:
        Size: 1024
      CodeUri: lambdas/svl-worker
      Handler: index.handler
      Description: "SVL (Schema Validation Layer) worker"
      LoggingConfig:
        LogFormat: JSON
      Environment:
        Variables:
          OUTPUT_BASE_URI: !Sub "s3://${OutputBucket}/outputs"
      Policies:
        - AWSLambdaBasicExecutionRole
        - arn:aws:iam::aws:policy/AmazonS3FullAccess
        - Version: "2012-10-17"
          Statement:
            - Effect: Allow
              Action:
                - states:SendTaskSuccess
                - states:SendTaskFailure
              Resource: "*"
      Events:
        SqsEvent:
          Type: SQS
          Properties:
            Queue: !GetAtt SvlQueue.Arn
            BatchSize: 1
            ScalingConfig:
              MaximumConcurrency: !Ref SvlWorkerConcurrency

  # MVL Worker (Docker-based for @elephant-xyz/cli mirror validation)
  MvlWorkerFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "${EnvironmentName}-mvl-worker"
      PackageType: Image
      MemorySize: 2048
      EphemeralStorage:
        Size: 3072
      Description: "MVL (Mirror Validation Layer) worker"
      LoggingConfig:
        LogFormat: JSON
      Environment:
        Variables:
          OUTPUT_BASE_URI: !Sub "s3://${OutputBucket}/outputs"
      Policies:
        - AWSLambdaBasicExecutionRole
        - arn:aws:iam::aws:policy/AmazonS3FullAccess
        - Version: "2012-10-17"
          Statement:
            - Effect: Allow
              Action:
                - states:SendTaskSuccess
                - states:SendTaskFailure
              Resource: "*"
      Events:
        SqsEvent:
          Type: SQS
          Properties:
            Queue: !GetAtt MvlQueue.Arn
            BatchSize: 1
            ScalingConfig:
              MaximumConcurrency: !Ref MvlWorkerConcurrency
    Metadata:
      DockerTag: latest
      DockerContext: .
      Dockerfile: lambdas/mvl-worker/Dockerfile

  # Hash Worker
  HashWorkerFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "${EnvironmentName}-hash-worker"
      Runtime: nodejs22.x
      MemorySize: 512
      EphemeralStorage:
        Size: 1024
      CodeUri: lambdas/hash-worker
      Handler: index.handler
      Description: "Hash generation worker"
      LoggingConfig:
        LogFormat: JSON
      Environment:
        Variables:
          OUTPUT_BASE_URI: !Sub "s3://${OutputBucket}/outputs"
      Policies:
        - AWSLambdaBasicExecutionRole
        - arn:aws:iam::aws:policy/AmazonS3FullAccess
        - Version: "2012-10-17"
          Statement:
            - Effect: Allow
              Action:
                - states:SendTaskSuccess
                - states:SendTaskFailure
              Resource: "*"
      Events:
        SqsEvent:
          Type: SQS
          Properties:
            Queue: !GetAtt HashQueue.Arn
            BatchSize: 1
            ScalingConfig:
              MaximumConcurrency: !Ref HashWorkerConcurrency

  # Upload Worker
  UploadWorkerFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "${EnvironmentName}-upload-worker"
      Runtime: nodejs22.x
      MemorySize: 512
      EphemeralStorage:
        Size: 1024
      CodeUri: lambdas/upload-worker
      Handler: index.handler
      Description: "Upload to IPFS worker"
      LoggingConfig:
        LogFormat: JSON
      Environment:
        Variables:
          ELEPHANT_PINATA_JWT: !Ref ElephantPinataJwt
          OUTPUT_BASE_URI: !Sub "s3://${OutputBucket}/outputs"
      Policies:
        - AWSLambdaBasicExecutionRole
        - arn:aws:iam::aws:policy/AmazonS3FullAccess
        - Version: "2012-10-17"
          Statement:
            - Effect: Allow
              Action:
                - states:SendTaskSuccess
                - states:SendTaskFailure
              Resource: "*"
      Events:
        SqsEvent:
          Type: SQS
          Properties:
            Queue: !GetAtt UploadQueue.Arn
            BatchSize: 1
            ScalingConfig:
              MaximumConcurrency: !Ref UploadWorkerConcurrency

  #####################################################################################################################
  # Step Functions State Machine
  #####################################################################################################################

  BuildTransactionStateMachine:
    Type: AWS::Serverless::StateMachine
    Properties:
      Name: !Sub "${EnvironmentName}-StateMachine"
      Type: STANDARD  # Standard workflow for long-running processes with waitForTaskToken
      DefinitionUri: build-transaction-workflow.asl.yaml
      DefinitionSubstitutions:
        TransformQueueUrl: !Ref TransformQueue
        SvlQueueUrl: !Ref SvlQueue
        MvlQueueUrl: !Ref MvlQueue
        HashQueueUrl: !Ref HashQueue
        UploadQueueUrl: !Ref UploadQueue
        ErrorsTableName: !If
          - CreateErrorsTable
          - !Ref WorkflowErrorsTable
          - !Ref ErrorsTableName
        ErrorResolutionEventBusName: !Ref ErrorResolutionEventBus
      Role: !GetAtt StateMachineRole.Arn
      Logging:
        Destinations:
          - CloudWatchLogsLogGroup:
              LogGroupArn: !GetAtt StateMachineLogGroup.Arn
        IncludeExecutionData: true
        Level: ALL
      Tracing:
        Enabled: true

  StateMachineLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/aws/vendedlogs/states/${EnvironmentName}-StateMachine"
      RetentionInDays: 14

  StateMachineRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: states.amazonaws.com
            Action: sts:AssumeRole
      Path: /service-role/
      Policies:
        - PolicyName: StateMachineExecutionPolicy
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              # SQS permissions for worker queues
              - Effect: Allow
                Action:
                  - sqs:SendMessage
                Resource:
                  - !GetAtt TransformQueue.Arn
                  - !GetAtt SvlQueue.Arn
                  - !GetAtt MvlQueue.Arn
                  - !GetAtt HashQueue.Arn
                  - !GetAtt UploadQueue.Arn
              # DynamoDB permissions for error tracking
              - Effect: Allow
                Action:
                  - dynamodb:PutItem
                  - dynamodb:GetItem
                  - dynamodb:UpdateItem
                  - dynamodb:Query
                Resource:
                  - !If
                    - CreateErrorsTable
                    - !GetAtt WorkflowErrorsTable.Arn
                    - !Sub "arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${ErrorsTableName}"
              # EventBridge permissions for Park states
              - Effect: Allow
                Action:
                  - events:PutEvents
                Resource:
                  - !GetAtt ErrorResolutionEventBus.Arn
              # CloudWatch Logs permissions
              - Effect: Allow
                Action:
                  - logs:CreateLogDelivery
                  - logs:GetLogDelivery
                  - logs:UpdateLogDelivery
                  - logs:DeleteLogDelivery
                  - logs:ListLogDeliveries
                  - logs:PutResourcePolicy
                  - logs:DescribeResourcePolicies
                  - logs:DescribeLogGroups
                Resource: "*"
              # X-Ray tracing
              - Effect: Allow
                Action:
                  - xray:PutTraceSegments
                  - xray:PutTelemetryRecords
                  - xray:GetSamplingRules
                  - xray:GetSamplingTargets
                Resource: "*"

  #####################################################################################################################
  # CloudWatch Dashboard
  #####################################################################################################################

  WorkflowDashboard:
    Type: AWS::CloudWatch::Dashboard
    Properties:
      DashboardName: !Sub "${EnvironmentName}-Dashboard"
      DashboardBody: !Sub |
        {
          "widgets": [
            {
              "type": "metric",
              "x": 0,
              "y": 0,
              "width": 12,
              "height": 6,
              "properties": {
                "metrics": [
                  ["AWS/States", "ExecutionsStarted", "StateMachineArn", "${BuildTransactionStateMachine}", {"stat": "Sum", "label": "Started"}],
                  ["AWS/States", "ExecutionsSucceeded", "StateMachineArn", "${BuildTransactionStateMachine}", {"stat": "Sum", "label": "Succeeded"}],
                  ["AWS/States", "ExecutionsFailed", "StateMachineArn", "${BuildTransactionStateMachine}", {"stat": "Sum", "label": "Failed"}]
                ],
                "period": 300,
                "stat": "Sum",
                "region": "${AWS::Region}",
                "title": "Workflow Executions",
                "view": "timeSeries"
              }
            },
            {
              "type": "metric",
              "x": 12,
              "y": 0,
              "width": 12,
              "height": 6,
              "properties": {
                "metrics": [
                  ["AWS/SQS", "ApproximateNumberOfMessagesVisible", "QueueName", "${EnvironmentName}-transform-queue", {"label": "Transform"}],
                  ["AWS/SQS", "ApproximateNumberOfMessagesVisible", "QueueName", "${EnvironmentName}-svl-queue", {"label": "SVL"}],
                  ["AWS/SQS", "ApproximateNumberOfMessagesVisible", "QueueName", "${EnvironmentName}-mvl-queue", {"label": "MVL"}],
                  ["AWS/SQS", "ApproximateNumberOfMessagesVisible", "QueueName", "${EnvironmentName}-hash-queue", {"label": "Hash"}],
                  ["AWS/SQS", "ApproximateNumberOfMessagesVisible", "QueueName", "${EnvironmentName}-upload-queue", {"label": "Upload"}]
                ],
                "period": 60,
                "stat": "Average",
                "region": "${AWS::Region}",
                "title": "Queue Depths",
                "view": "timeSeries"
              }
            },
            {
              "type": "metric",
              "x": 0,
              "y": 6,
              "width": 24,
              "height": 6,
              "properties": {
                "metrics": [
                  ["AWS/Lambda", "Duration", "FunctionName", "${EnvironmentName}-transform-worker", {"stat": "Average", "label": "Transform"}],
                  ["AWS/Lambda", "Duration", "FunctionName", "${EnvironmentName}-svl-worker", {"stat": "Average", "label": "SVL"}],
                  ["AWS/Lambda", "Duration", "FunctionName", "${EnvironmentName}-mvl-worker", {"stat": "Average", "label": "MVL"}],
                  ["AWS/Lambda", "Duration", "FunctionName", "${EnvironmentName}-hash-worker", {"stat": "Average", "label": "Hash"}],
                  ["AWS/Lambda", "Duration", "FunctionName", "${EnvironmentName}-upload-worker", {"stat": "Average", "label": "Upload"}]
                ],
                "period": 300,
                "stat": "Average",
                "region": "${AWS::Region}",
                "title": "Worker Duration (ms)",
                "view": "timeSeries"
              }
            },
            {
              "type": "metric",
              "x": 0,
              "y": 12,
              "width": 24,
              "height": 6,
              "properties": {
                "metrics": [
                  ["AWS/Lambda", "Errors", "FunctionName", "${EnvironmentName}-transform-worker", {"stat": "Sum", "label": "Transform Errors"}],
                  ["AWS/Lambda", "Errors", "FunctionName", "${EnvironmentName}-svl-worker", {"stat": "Sum", "label": "SVL Errors"}],
                  ["AWS/Lambda", "Errors", "FunctionName", "${EnvironmentName}-mvl-worker", {"stat": "Sum", "label": "MVL Errors"}],
                  ["AWS/Lambda", "Errors", "FunctionName", "${EnvironmentName}-hash-worker", {"stat": "Sum", "label": "Hash Errors"}],
                  ["AWS/Lambda", "Errors", "FunctionName", "${EnvironmentName}-upload-worker", {"stat": "Sum", "label": "Upload Errors"}]
                ],
                "period": 300,
                "stat": "Sum",
                "region": "${AWS::Region}",
                "title": "Worker Errors",
                "view": "timeSeries"
              }
            }
          ]
        }

Outputs:
  StateMachineArn:
    Description: ARN of the Build Transaction State Machine
    Value: !Ref BuildTransactionStateMachine

  StateMachineName:
    Description: Name of the Build Transaction State Machine
    Value: !GetAtt BuildTransactionStateMachine.Name

  TransformQueueUrl:
    Description: URL of the Transform worker queue
    Value: !Ref TransformQueue

  SvlQueueUrl:
    Description: URL of the SVL worker queue
    Value: !Ref SvlQueue

  MvlQueueUrl:
    Description: URL of the MVL worker queue
    Value: !Ref MvlQueue

  HashQueueUrl:
    Description: URL of the Hash worker queue
    Value: !Ref HashQueue

  UploadQueueUrl:
    Description: URL of the Upload worker queue
    Value: !Ref UploadQueue

  ErrorsTableName:
    Description: Name of the Errors DynamoDB table
    Value: !If
      - CreateErrorsTable
      - !Ref WorkflowErrorsTable
      - !Ref ErrorsTableName

  ErrorResolutionEventBusName:
    Description: Name of the Error Resolution EventBridge bus
    Value: !Ref ErrorResolutionEventBus

  TransformWorkerFunctionArn:
    Description: ARN of the Transform worker Lambda
    Value: !GetAtt TransformWorkerFunction.Arn

  SvlWorkerFunctionArn:
    Description: ARN of the SVL worker Lambda
    Value: !GetAtt SvlWorkerFunction.Arn

  MvlWorkerFunctionArn:
    Description: ARN of the MVL worker Lambda
    Value: !GetAtt MvlWorkerFunction.Arn

  HashWorkerFunctionArn:
    Description: ARN of the Hash worker Lambda
    Value: !GetAtt HashWorkerFunction.Arn

  UploadWorkerFunctionArn:
    Description: ARN of the Upload worker Lambda
    Value: !GetAtt UploadWorkerFunction.Arn

  DashboardUrl:
    Description: URL to the CloudWatch Dashboard
    Value: !Sub "https://${AWS::Region}.console.aws.amazon.com/cloudwatch/home?region=${AWS::Region}#dashboards:name=${EnvironmentName}-Dashboard"
